---
title: "US_Rt_interventions"
author: "Bingyi Yang, Angkana Huang and Derek Cummings"
date: "18/02/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)

irpkg = function(pkg){
  
  installed = installed.packages()[ ,1]
  new = pkg[!(pkg %in% installed)]
  
  if(length(new)){
    install.packages(new, dependencies = TRUE)
  }
  
  silent = sapply(pkg, require, character.only = TRUE)
  
}

packages = c("knitr",
             "ggplot2",
             "forecast",
             "hts",
             "tidyr",
             "dplyr",
             "gbm",
             "reshape2",
             "gridExtra",
             "olsrr",
             "Gifi",
             "gee",
             "glmnet",
             "scales",
             "dummies",
             "GGally",
             "mgcv",
             "geepack",
             "ggpmisc",
             "cowplot",
             "tidycensus",
             "lemon",
             "ggridges",
             "ggpubr",
             "GEEmediate",
             "mediation",
             "tidyverse",
             "fixest")

irpkg(packages)


# load data

case = read.csv('data/confirmed_cases.csv', 
                header = TRUE, 
                stringsAsFactors = FALSE) %>%
  mutate(first_case = as.Date(first_case))

death = read.csv('data/confirmed_deaths.csv', 
                 header = TRUE, 
                 stringsAsFactors = FALSE)

school = read.csv('data/school.csv',
                  header = TRUE,
                  stringsAsFactors = FALSE)

covariates = read.csv('data/covariates.csv',
                      header = TRUE,
                      stringsAsFactors = FALSE)

rt = read.csv('rt/rt.csv',
              header = TRUE,
              stringsAsFactors = FALSE)

data.google = left_join(rt, covariates)
data.google$Date = as.Date(data.google$Date)


state_intv = read.csv('data/Intervention_googlesheet.csv',
                      header = TRUE, stringsAsFactors = FALSE)

# settings
weeks = paste('week', c('neg2', 'neg1',
                        0:13), 
              sep = '_')

intv.colums = c(27:32, 34) # state level interventions & no state_of_emergency
interventions = colnames(data.google)[intv.colums]

interventions_post = c(sapply(interventions, function(i) paste(i, 
                                                               c('pre', 'implement', 'post'),
                                                               sep = '_')))

n = ncol(case)

case_dates = colnames(case)[4:(n-1)]
case_dates = as.Date(gsub('X', '', case_dates),
                      '%Y.%m.%d')


```

# Figure 1

## Fig. 1a-b: Time series of national daily confirmed cases

```{r fig 1a-b, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE}

# load case data

case.total = tibble(
  
  Date = case_dates,
  cum.case = colSums(case[ ,4:(n-1)]),
  cum.death = colSums(death[ ,4:(n-1)])
  
) %>%
  mutate(
    
    daily.case = diff(c(0, cum.case)),
    daily.death = diff(c(0, cum.death)),
    daily.nonfatal.case = daily.case - daily.death
    
  )

case.inset = case.total %>%
  filter(Date <= as.Date('2020-03-10'))

dates = as.Date(c('2020-01-15',
                  '2020-02-01',
                  '2020-02-15',
                  '2020-03-01',
                  '2020-03-15',
                  '2020-04-01',
                  '2020-04-15',
                  '2020-05-01',
                  '2020-05-15',
                  '2020-06-01',
                  '2020-06-15',
                  '2020-06-30',
                  '2020-07-15'),
                '%Y-%m-%d')

main.case = ggplot(case.total,
                   aes(x = Date,
                       y = daily.case)) +
  geom_bar(stat = 'identity',
           color = 'white',
           aes(fill = "Cases")) +
  theme_bw() +
  labs(title = "a",
       x = 'Date',
       y = 'Confirmed cases') +
  scale_y_continuous(limits = c(0, 60000),
                     expand = c(0.01, 0)) + 
  scale_x_date(breaks = dates,
               date_labels = "%b-%d") +
  theme(axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.margin = unit(c(1,1,1,1), "cm"),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = c(0.85, 1),
        legend.text = element_text(size = 16)) +
  scale_fill_manual(name="",
                      values = c(Cases = "#1e4c76",
                                 Deaths = '#983020'))


inset.case = ggplot(case.inset,
                    aes(x = Date,
                        y = daily.case)) +
  theme_bw() +
  labs(title = "",
       x = '',
       y = '') +
  scale_y_continuous(limits = c(0, 300),
                     expand = c(0.01, 0)) +
  scale_x_date(limits = c(dates[1], as.Date('2020-03-10')+1),
               breaks = c(dates[1:4], as.Date('2020-03-10')),
               date_labels = "%b-%d",
               expand = c(0, 0)) +
  theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"), 
        legend.position = 'none') +
  scale_fill_manual(name="",
                      values = c(Cases = "#1e4c76",
                                 Deaths = '#983020')) +
  geom_rect(aes(xmin = Date - 0.4,
                xmax = Date + 0.4,
                ymin = 0,
                ymax = daily.case,
                fill = "Cases"))

main.death = ggplot(case.total,
                   aes(x = Date,
                       y = daily.death)) +
  geom_bar(stat = 'identity',
           color = 'white',
           aes(fill = "Deaths")) +
  theme_bw() +
  labs(title = "b",
       x = 'Date',
       y = 'Confirmed deaths')  +
  scale_y_continuous(limits = c(0, 5000),
                     expand = c(0.01, 0)) +
  scale_x_date(breaks = dates,
               date_labels = "%b-%d") +
  theme(axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.margin = unit(c(1,1,1,1), "cm"),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = c(0.85, 1),
        legend.text = element_text(size = 16)) +
  scale_fill_manual(name="",
                      values = c(Cases = "#1e4c76",
                                 Deaths = '#983020'))

inset.death = ggplot(case.inset,
                    aes(x = Date,
                        y = daily.death)) +
  theme_bw() +
  labs(title = "",
       x = '',
       y = '') +
  scale_y_continuous(limits = c(0, 8),
                     expand = c(0.01, 0)) +
  scale_x_date(limits = c(dates[1], as.Date('2020-03-10')+1),
               breaks = c(dates[1:4], as.Date('2020-03-10')),
               date_labels = "%b-%d",
               expand = c(0, 0)) +
  theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"), 
        legend.position = 'none') +
  scale_fill_manual(name="",
                      values = c(Cases = "#1e4c76",
                                 Deaths = '#983020')) +
  geom_rect(aes(xmin = Date - 0.4,
                xmax = Date + 0.4,
                ymin = 0,
                ymax = daily.death,
                fill = "Deaths"))

fig1a <-
  ggdraw() +
  draw_plot(main.case) +
  draw_plot(inset.case, x = 0.1, y = .5, width = .35, height = .45)

fig1b <-
  ggdraw() +
  draw_plot(main.death) +
  draw_plot(inset.death, x = 0.1, y = .5, width = .35, height = .45)


```

## Fig. 1c: Rt by weeks since first case in county

```{r fig 1c, fig.align='center', message=FALSE, warning=FALSE, fig1C echo=FALSE, include=FALSE}

smr.county = data.frame(t(sapply(weeks, function(w){
  
  print(w)
  quantile(data.google$Rt_mean[data.google[, w] == 1], 
           c(.025, .25, .5, .75, .975),
           na.rm = TRUE)
  
})))
colnames(smr.county) = c('Q025', 'Q25', 'Median', 'Q75', 'Q975')
smr.county$week = factor(rownames(smr.county),
                         levels = rownames(smr.county))


fig1c = ggplot(data = smr.county,
                        aes(x = week,
                            y = Median)) +
  geom_point(color = '#B22234') +
  # ylim(0, 15) +
  geom_errorbar(aes(ymin=Q025,
                    ymax=Q975), 
                width=0,
                alpha = 0.4,
                color = '#B22234') +
  geom_errorbar(aes(ymin=Q25,
                    ymax=Q75), 
                width=0.2,
                alpha = 1,
                color = '#B22234') + 
  geom_hline(yintercept = 1,
             color = grey(0.4)) + 
  labs(x = "Weeks since county's first case",
       y = expression(R[eff]),
       title = 'c') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.position = c(0.75, 0.85)) + 
  scale_x_discrete(labels = c('-2', '',
                              '0', '',
                              '2',  '',
                              '4',  '',
                              '6',  '',
                              '8',  '',
                              '10',  '',
                              '12',  '')) +
    scale_y_continuous(breaks = c(0.1, 0.5, 1, 10, 25, 50),
                       limits = c(0.1, 50),
                       trans = 'log10',
                       expand = c(0, 0))


```

## Fig. 1d: time series of county Rt
```{r fig 1d, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE}

selectCounty = function(data, method){
  
  data.used = unique(data[, c('FIPS', 'state_name', 'log10_popsize')])
  data.used = data.used[order(-data.used$log10_popsize), ]
  
  if(method == 'mostPopDens'){
    
    counties = data.used$FIPS[1:50]
    
  }
  
  if(method == 'mostPopDensByState'){
    
    state = unique(data.used$state_name)
    
    counties = sapply(state, function(s){
      
      data.used$FIPS[data.used$state_name == s][1]
      
    })
    
  }
  
  if(method == 'quantile'){
    
    data.used$quantile = cut(data.used$log10_popsize,
                             breaks = quantile(data.used$log10_popsize),
                             labels = paste('Q', 1:4, sep = ''))
    data.used$quantile = as.character(data.used$quantile)
    
    counties = sapply(c('Q1', 'Q2', 'Q3', 'Q4'), function(q) data.used$FIPS[data.used$quantile == q])
    
  }
  
  if(method == 'perfectCut'){
    
    data.used$quantile = cut(data.used$log10_popsize,
                             breaks = log10(c(100, 15000, 30000, 90000, 10^7)),
                             labels = paste('Q', 1:4, sep = ''))
    data.used$quantile = as.character(data.used$quantile)
    
    counties = sapply(c('Q1', 'Q2', 'Q3', 'Q4'), function(q) data.used$FIPS[data.used$quantile == q])
    
  }
  
  return(counties)
  
}

countyRtTsSmrPlot = function(data, method){
  
  counties = selectCounty(data = data, 
                          method = method)
  
  dates = unique(data$Date)
  dates = dates[order(dates)]
  
  melt_counties = melt(counties)[ ,c(2:1)]
  colnames(melt_counties) = c('Quantile', 'FIPS')
  melt_counties = melt_counties[!is.na(melt_counties$FIPS), ]
  
  if(method == 'perfectCut'){
    
    lbs = c('< 15k',
            '15k to 30k',
            '30k to 90k',
            '> 90k')
    nm = 'Population size'
    
  }
  if(method == 'quantile'){
    
    lbs = unique(melt_counties$Quantile)
    nm = 'Population size \n (from smallest to largest)'
    
  }
  

  smr = lapply(c('Q1', 'Q2', 'Q3', 'Q4'), function(x) {
    
    used = data[data$FIPS %in% melt_counties$FIPS[melt_counties$Quantile == x],
                c('Date', 'Rt_mean')]
    
    tem = t(sapply(dates, function(d) quantile(used$Rt_mean[used$Date == d],
                                              c(.025, .25, .5, .75, .975),
                                              na.rm = TRUE)))
    
    colnames(tem) = c('Q025', 'Q25', 'Median', 'Q75', 'Q975')
    
    data.frame(date = dates,
               quantile = x,
               tem,
               stringsAsFactors = FALSE)
    
  })
  
  smr = do.call('rbind', smr)
  
  smr$Q975[smr$Q975 > 50] = 50
  
  colors = c('#0084ff',
             '#44bec7',
             '#ffc300',
             '#fa3c4c')
  smr$date = as.Date(smr$date)
  
  ggplot(data = smr,
         aes(x = date,
             y = Median,
             group = quantile,
             color = quantile)) +
    geom_point(aes(color = quantile),
               position=position_dodge(4)) +
    geom_errorbar(aes(ymin=Q025,
                      ymax=Q975), 
                  width=0,
                  position=position_dodge(4),
                  alpha = 0.3) +
    geom_errorbar(aes(ymin=Q25,
                      ymax=Q75), 
                  width=6,
                  position=position_dodge(4),
                  alpha = 1) + 
    geom_hline(yintercept = 1,
               color = grey(0.4)) + 
    labs(x = 'Time',
         y = expression(R[eff]),
         title = 'd') +
    scale_color_manual(values=colors,
                       name = nm,
                       labels = lbs)+
    theme_classic() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     size = 16,
                                     color = 'black'),
          axis.text.y = element_text(size = 16,
                                     color = 'black'),
          strip.text.x = element_text(size = 16, face = "bold"),
          strip.background = element_blank(),
          axis.title.x = element_text(size = 16, face = 'bold'),
          axis.title.y = element_text(size = 16, face = 'bold'),
          plot.title = element_text(size = 20, face = 'bold'),
          plot.title.position = "plot",
          plot.margin = unit(c(1,1,1,1), "cm"),
          legend.position = c(0.75, 0.85),
          legend.text = element_text(size = 16,
                                     color = 'black'),
          legend.title = element_text(size = 16,
                                     color = 'black')) +
    scale_y_continuous(breaks = c(0.1, 0.5, 1, 10, 25, 50),
                       limits = c(0.1, 50),
                       trans = 'log10',
                       expand = c(0, 0)) +
    scale_x_date(limits = c(as.Date('2020-02-01'),
                            as.Date('2020-06-15')))
}

fig1d = countyRtTsSmrPlot(data.google, method = 'perfectCut')

```

## Fig. 1e & Fig. S1: weekly rt map
```{r fig 1e and S1, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE}

data(state_laea, package = "tidycensus")
data(fips_codes, package = "tidycensus")


fips = read.csv('data/FIPS.csv')

# county_rt = data.google %>%
#   select('FIPS', 'Date', 'Rt_mean')

county_rt = data.google %>%
  dplyr::select('FIPS', 'Date', 'Rt_mean')


county_rt$Rt_mean = if_else(county_rt$Rt_mean > 5, 5, county_rt$Rt_mean)
county_rt$Rt_mean = if_else(county_rt$Rt_mean < 10^-2, 10^-2, county_rt$Rt_mean)

county_rt = county_rt %>% spread('Date', 'Rt_mean')

county_rt$FIPS = sprintf('%05.f', county_rt$FIPS)
colnames(county_rt)[-1] = gsub('-', '', colnames(county_rt)[-1])
colnames(county_rt)[-1] = paste("W",
                                colnames(county_rt)[-1],
                                sep = "")

weeks_dates = seq(as.Date("2020-02-08"),
                  as.Date("2020-06-13"),
                  7)

countyMapPlot = function(county_rt, week, supp){

  data(county_laea, package = "tidycensus")

  cols.used = paste("W",
                  gsub("-", "", week),
                  sep = "")

  used_rt = county_rt %>%
                dplyr::select(FIPS, cols.used)
  colnames(used_rt)[2] = 'Rt'

  countymap = county_laea %>%
    left_join(used_rt,
              by = c("GEOID" = "FIPS"))
  if(!supp){
    if(week == "2020-02-29"){
      tlt = 'e  '
    } else {tlt = ''}
  } else {tlt = ''}
  

  countymap %>%
    ggplot(aes(fill = Rt)) +
    geom_sf(color = "white",
            size = 0.05) +
    scale_fill_gradient2(low = "#2c80af",
                         mid = "white",
                         high = "#d13313",
                         midpoint = 1,
                         space = "Lab",
                         name = expression(paste('Weekly R'[eff])),
                         limits = c(0, 5)) +
    theme_void() +
    theme(plot.margin = unit(c(1,1,1,1), "cm"),
          legend.text = element_text(size=16),
          legend.title = element_text(size=16,
                                      face = 'plain',
                                      hjust = 0),
          legend.position = "right",
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot") +
    ggtitle(paste(tlt,
                  format(week, "%b %d")))

}

countymap = lapply(weeks_dates, countyMapPlot, county_rt = county_rt, supp = FALSE)


```

## figure 1 output
```{r fig 1, echo=FALSE, fig.width=20, fig.height=15, warning=FALSE, message=FALSE, fig.align='center'}


sel = seq(from = length(countymap), 
          to = 1, 
          by = -3)

jpeg('output/plot/fig_1.jpeg', width = 16*600, height = 18*600, res = 600)
# pdf('output/plot/fig_1.pdf',
#     width = 16, height = 18)

pR2 = ggarrange(fig1c,
                fig1d,
                nrow = 1,
                widths = c(1, 2),
                align = 'h')
pR3 = ggarrange(countymap[[sel[6]]],
                countymap[[sel[5]]],
                countymap[[sel[4]]],
                countymap[[sel[3]]],
                countymap[[sel[2]]],
                countymap[[sel[1]]],
                nrow =2, ncol = 3,
                align = 'hv')

ggarrange(fig1a,
          fig1b,
          pR2,
          pR3,
          heights=c(5.5, 5.5, 5.5, 11),
          nrow = 4,
          align = 'h')

dev.off()

```


# Figure 2

## Fig. 2a: Time series of proportion of states that implemented interventions

```{r fig 2a, echo=FALSE, fig.align='center', fig.height=6, fig.width=12, message=FALSE, warning=FALSE}

state = unique(data.google$state_name)
FIPS = unique(data.google$FIPS)
times = unique(data.google$Date)
times = times[order(times)]

colors = c('#053853',
           '#2859b8',
           '#38a1db',
           '#98dce8',
           '#6766cc',
           '#7301ed',
           '#abda00')

p.intv = lapply(interventions, function(i){
  
  
  if(i != 'earliest_date_school_closed'){
    
    tem = lapply(state, function(s){
    
    used = data.google[data.google$state_name == s, ]
    
    sapply(times, function(t){
      
      tem = used[used$Date == t, i]
      if(all(tem==0) | length(tem) == 0){
        0
      } else {1}
      
    })
    
  })
    
    tem = do.call('rbind', tem)
    
    df = data.frame(intervention = i,
                    date = times,
                    proportion = colSums(tem)/51,
                    stringsAsFactors = FALSE)
    
  }
  
  if(i == 'earliest_date_school_closed'){
    
      fips.county = unique(data.google$FIPS[data.google$county_school_closure_na == 0])
      
    tem = lapply(fips.county, function(s){
      
      # print(s)
      
      used = school$earliest_date_school_closed[school$FIPS == s]
      
      raw = rep(0, length(times))
      raw[times >= used] = 1
      
      raw

    
  })
    
    tem = do.call('rbind', tem)
    
    df = data.frame(intervention = i,
                    date = times,
                    proportion = colSums(tem, na.rm = TRUE)/length(fips.county),
                    stringsAsFactors = FALSE)
    
    
  }
  
  return(df)
  
})

p.intv = do.call('rbind', p.intv)
p.intv$intervention = factor(p.intv$intervention,
                            levels = c('lv3_stay_home',
                                       'lifestyle_close',
                                       'daycare_close',
                                       'earliest_date_school_closed',
                                       'ban_nursing_home_visit',
                                       'suspend_medical',
                                       'face_mask'))
p.intv$level = 'state'
p.intv$level[p.intv$intervention == 'earliest_date_school_closed'] = 'county'
 
fig2a = ggplot(p.intv,
        aes(x = date,
           y = proportion,
           color = intervention)) +
  geom_point(size = 2,
             alpha = 0.8) + 
  geom_line(size = 1,
            alpha = 0.8,
            aes(x = date,
                y = proportion,
                group = intervention,
                linetype = level)) +
  scale_color_manual(values = colors,
                     name = 'Intervention',
                     labels = c('Stay at home',
                                'Leisure activities closure',
                                'Daycare closure',
                                'School closure',
                                'Nursing home visit ban',
                                'Medical service suspension',
                                'Face mask')) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = 16, color = 'black'),
        axis.text.y = element_text(size = 16, color = 'black'),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.position = c(0.2, 0.6),
        strip.background = element_blank(),
        strip.text = element_text(size = 16, face = "bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(),
        plot.margin = unit(c(1,1,1,1), "cm"),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = 'plot') +
  labs(x = 'Time',
       y = 'Proportion of implementions',
       title = 'a') +
  scale_linetype_manual(values = c('twodash',
                                   'solid'),
                        name = 'Level',
                        labels = c('County',
                                   'State'))

fig2a

```

## Fig. 2b: Ridgeplot of interventions time relative to county's first case

```{r fig 2b, echo=FALSE, fig.align='center', fig.height=12, fig.width=9, message=FALSE, warning=FALSE}

county_intervention_time = lapply(FIPS, function(f){
  
  s = unique(data.google$state_name[data.google$FIPS == f])
  
  intv.time = sapply(interventions, function(i){

    
    if(i != 'earliest_date_school_closed'){
      
      used = state_intv$dateStart[state_intv$state_name == s & 
                                  state_intv$intervention == i]
      used = as.Date(used)
      
      as.numeric(used - case$first_case[case$FIPS == f])/7
      
    } else {
      
      con = school$FIPS == f
      
      if(sum(con) == 0){
        
        NA
        
      } else {
        
        used = school$earliest_date_school_closed[con]
        
        used = as.Date(used)
        as.numeric(used - case$first_case[case$FIPS == f])/7
         
      }
      
    }
    
   
    
    
  })
  
  df = data.frame(FIPS = f,
                  intervention = interventions,
                  intervention_time = as.numeric(intv.time),
                  stringsAsFactors = FALSE)
  
  return(df)
  
})
county_intervention_time = do.call('rbind', county_intervention_time)
county_intervention_time$intervention = factor(county_intervention_time$intervention,
                                               levels = rev(c('lv3_stay_home',
                                                              'lifestyle_close',
                                                              'daycare_close',
                                                              'earliest_date_school_closed',
                                                              'ban_nursing_home_visit',
                                                              'suspend_medical',
                                                              'face_mask')))

colors = rev(c('#053853',
           '#2859b8',
           '#38a1db',
           '#98dce8',
           '#6766cc',
           '#7301ed',
           '#abda00'))

fig2b = ggplot(county_intervention_time,
                 aes(x = intervention_time,
                     y = intervention)) +
   geom_density_ridges(aes(fill = intervention,
                           color = intervention),
                       bandwidth = 1,
                       scale = 1,
                       alpha = 0.2,
                       quantile_lines = TRUE, 
                       quantiles = 0.5) +
  geom_vline(xintercept = 0,
             linetype = 2,
             size = 0.8,
             color = grey(0.3)) +
  scale_fill_manual(values = colors) +
  scale_color_manual(values = colors) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.title = element_text(size = 16),
        legend.position = 'none',
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(),
        plot.margin = unit(c(1,1,1,1), "cm"),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = 'plot')  +
   xlim(-5, 15) +
  scale_y_discrete(labels = rev(c("State of emergency",
                                  "Stay at home",
                                  "Leisure activities closure",
                                  "Daycare closure",
                                  "School closure",
                                  "Nursing home visit ban",
                                  "Medical service suspension",
                                  "Face mask"))) +
  labs(x = 'Weeks since county\'s first case',
       y = "",
       title = 'b')

fig2b

```

## figure 2 output
```{r fig 2, echo=FALSE, fig.width=18, fig.height=14, warning=FALSE, message=FALSE, fig.align='center'}

# jpeg('output/plot/fig_2.jpeg', width = 14*600, height = 15*600, res = 600)
pdf('output/plot/fig_2.pdf', width = 14, height = 15)
grid.arrange(fig2a,
             fig2b,
             heights=c(4, 6),
             layout_matrix = rbind(1, 2))
dev.off()

```


# Figure 3

## Fit main model and sensitivity analyses

```{r Fit main model, echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE, include=FALSE}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset

country_weeks = dummy(dat$time_since_national_start, sep = '_')
colnames(country_weeks) = paste('country_week', 6:21, sep = '_')

a = dummy(data.google$week, sep = '_')
colnames(a) = paste('week', -2:13, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))
  
modelFit = function(model, dat, stateLevel){
  
  print(model)
  
  if(stateLevel){
    
    state_interventions = c("daycare_close",
                            "face_mask",
                            "lifestyle_close",
                            "lv3_stay_home",
                            "ban_nursing_home_visit",
                            "suspend_medical",
                            "school_close_state")
    
  } else {
    
    state_interventions = colnames(data.google)[intv.colums]
    
  }
  
  # set up
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      "log10_popdense"),
                    
                    state_interventions = state_interventions,
                    
                    state = "state_name",
                  
                    county_time = c(colnames(a)[3:ncol(a)]),
                    
                    country_time = c(colnames(country_weeks)[2:ncol(country_weeks)]),
                  
                    autoregressive = "log_Rt_previous")
  
  model.types = list(main = 'GEE', 
                     base = 'GEE', 
                     timeOnly = 'GEE',
                     timeIntv = 'GEE', 
                     
                     lmMain = 'Linear',
                     lmBase = 'Linear',
                     lmTimeOnly = 'Linear',
                     lmTimeIntv = 'Linear', 
                     
                     lassoMain = 'LASSO',
                     lassoTime = 'LASSO',
                     lassoIntv = 'LASSO',
                     
                     countryTimeIntv = 'GEE',
                     lmCountryTimeIntv = 'Linear')
  
  model.predictors = list(main = c('county_census',
                                   'state_interventions',
                                   'state'),
                        
                          base = c('county_census',
                                   'state'),
                        
                          timeOnly = c('county_time',
                                       'county_census',
                                       'state'),
                        
                          timeIntv = c('state_interventions',
                                       'county_time',
                                       'county_census',
                                       'state'),
                        
                          lmMain = c('autoregressive',
                                     'county_census',
                                     'state_interventions',
                                     'state'),
                                                    
                          lmBase = c('autoregressive',
                                     'county_census',
                                     'state'),
                        
                          lmTimeOnly = c('autoregressive',
                                         'county_time',
                                         'county_census',
                                         'state'),
                        
                          lmTimeIntv = c('autoregressive',
                                         'state_interventions',
                                         'county_time',
                                         'county_census',
                                         'state'),
                          
                          lassoMain = c('autoregressive',
                                        'county_census',
                                        'state_interventions',
                                        'state'),
                        
                          lassoTime = c('autoregressive',
                                        'county_census',
                                        'state'),
                        
                          lassoIntv = c('county_census',
                                        'state_interventions',
                                        'state'),
                          
                          countryTimeIntv = c('state_interventions',
                                              'country_time',
                                              'county_census',
                                              'state'),
                          
                          lmCountryTimeIntv = c('autoregressive',
                                                'state_interventions',
                                                'country_time',
                                                'county_census',
                                                'state'))
  
  xs = unlist(sapply(model.predictors[[model]], function(x) predictors[[x]]))
  
  fml.log <-  paste('log_Rt ~ ',
                    paste(xs, collapse = " + "),
                    sep = "")
  
  fml.used <- as.formula(fml.log)

  if(model.types[[model]] == 'Linear'){

    m = lm(fml.used,
           weights = weights,
           data = dat)

  }

  if(model.types[[model]] == 'GEE'){

    m = geeglm(fml.used,
                data = dat,
                id = FIPS,
                corstr = "ar1",
                weights = weights)



  }

  if(model.types[model][[1]] == 'LASSO'){

    lambda = seq(0, 0.1, 0.005)

    x = model.matrix(log_Rt ~ .-1,
                     dat[ ,c(xs,
                                   'log_Rt')])
    y = dat$log_Rt
    w = dat$weights

    m = glmnet(x,
               y,
               alpha = 1,
               lambda = lambda,
               weights = w)

  }

  return(m)

}

models = lapply(c("main",
                  "base",
                  "timeOnly",
                  "timeIntv",
                  
                  "lmMain",
                  "lmBase",
                  "lmTimeOnly",
                  "lmTimeIntv",
                  
                  "lassoMain",
                  "lassoTime",
                  "lassoIntv",
                  
                  "countryTimeIntv",
                  "lmCountryTimeIntv"
                  ),
                modelFit,
                dat = dat,
                stateLevel = FALSE)

names(models) = c("main",
                  "base",
                  "timeOnly",
                  "timeIntv",
                  
                  "lmMain",
                  "lmBase",
                  "lmTimeOnly",
                  "lmTimeIntv",
                  
                  "lassoMain",
                  "lassoTime",
                  "lassoIntv",
                  
                  "countryTimeIntv",
                  "lmCountryTimeIntv")


```


## Fig. 3b: LASSO

Use population density (log-transformed) as predictor.

```{r fig 3b - LASSO, echo=FALSE, fig.align='cneter', fig.height=6, fig.width=8}

getMelt = function(model){

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")

  # coeficient matrix
  mat = as.matrix(coef(model)[nm, ])
  colnames(mat) <- paste('L', model$lambda, sep = '')
  mat = data.frame(var = rownames(mat),
                 mat,
                 stringsAsFactors = FALSE)
  melt_mat = mat %>% gather(lambda, coef, -var)
  melt_mat$coef[melt_mat$coef == 0] <- NA
  melt_mat$lambda = as.numeric(gsub('L', '', melt_mat$lambda))

  lvls <- data.frame(var = unique(melt_mat$var),
                     stringsAsFactors = FALSE)
  lvls$na = sapply(lvls$var, function(x) sum(is.na(melt_mat$coef[melt_mat$var == x])))
  lvls$cat = 2
  lvls$cat[lvls$var %in% c("log10_popsize",
                           "med_income",
                           "percent_poverty",
                           'log10_popdense',
                           'med_age',
                           'prop_white',
                           'prop_belowCollege')] = 1
  lvls = lvls[order(lvls$cat, -lvls$na), ]

  melt_mat$var = factor(melt_mat$var, 
                        levels = lvls$var)

  melt_mat

}

melt_mat = getMelt(models$lassoMain)
melt_mat$coef = 10^(melt_mat$coef)

intv.order = intv = levels(melt_mat$var)
labels.order = c('log10_popsize' = 'Log population size',
                 'log10_popdense' = 'Log population density',
                 'med_income' = 'Median income',
                 'percent_poverty' = 'Decile of poverty',
                 'med_age' = 'Median age',
                 'prop_white' = 'Decile of white',
                 'prop_belowCollege' = 'Decile of below college',
  
                 'suspend_medical' = 'Medical service suspension',
                 'face_mask' = 'Face mask',
                 'ban_nursing_home_visit' = 'Nursing home visit ban',
                 'daycare_close' = 'Daycare closure',
                 'lv3_stay_home' = 'Stay at home',
                 'lifestyle_close' = 'Leisure activities closure',
                 'earliest_date_school_closed' = 'School closure')
labels.order.abb = c('log10_popsize' = 'Log population size (Pop)',
                     'log10_popdense' = 'Log population density (PopD)',
                 'med_income' = 'Median income (Inc)',
                 'percent_poverty' = 'Decile of poverty (Pov)',
                 'med_age' = 'Median age (Age)',
                 'prop_white' = 'Decile of white (Race)',
                 'prop_belowCollege' = 'Decile of below college (Edu)',
  
                 'suspend_medical' = 'Medical service suspension (MS)',
                 'face_mask' = 'Face mask (FM)',
                 'ban_nursing_home_visit' = 'Nursing home visit ban (NH)',
                 'daycare_close' = 'Daycare closure (DC)',
                 'lv3_stay_home' = 'Stay at home (SH)',
                 'lifestyle_close' = 'Leisure activities closure (LA)',
                 'earliest_date_school_closed' = 'School closure (SC)')
labels.abb = c('log10_popsize' = 'Pop',
                'log10_popdense' = 'PopD',
                 'med_income' = 'Inc',
                 'percent_poverty' = 'Pov',
                 'med_age' = 'Age',
                 'prop_white' = 'Race',
                 'prop_belowCollege' = 'Edu',
  
                 'suspend_medical' = 'MS',
                 'face_mask' = 'FM',
                 'ban_nursing_home_visit' = 'NH',
                 'daycare_close' = 'DC',
                 'lv3_stay_home' = 'SH',
                 'lifestyle_close' = 'LA',
                 'earliest_date_school_closed' = 'SC')


fig3B = ggplot(melt_mat,
       aes(x = lambda,
           y = var,
           fill = coef)) +
  geom_tile(color = 'black') +
  scale_fill_gradientn(colours = c('#3C3B6E', "white", "#B22234"),
                       guide = "colorbar",
                       values = rescale(c(0.4, 1, 1.2)),
                       limits=c(0.4, 1.2),
                       name="Relative changes in Rt, %",
                       space = "Lab",
                       na.value = grey(0.9),
                       breaks = c(0.40, 0.70, 1, 1.2),
                       labels = c('-60', '-30', '0', '20')) +
  theme_bw() +
  labs(y = '',
       x = 'Lambda (penalty)',
       title = 'b') +
  theme(axis.text.x = element_text(size = 16,
                                   color = 'black'),
        # axis.text.y = element_text(size = 14,
        #                            color = 'black'),
        axis.title.x = element_text(size = 16,
                                    face = 'bold'),
        axis.title.y = element_text(size = 16,
                                    face = 'bold'),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 24, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top') 

fig3B

```


## Fig. 3a: GEEs and OLS

```{r fig 3a - GEEs and OLS, echo=FALSE, fig.height=5, fig.width=8}

est <- lapply(c('main', 'lmMain'),
              function(model){# 1 = gee; 2 = log-lm

 nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model == 'main'){type = 'GEE'} else {type = 'OLS'}

  esti = summary(models[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   variables = c(rep("Census", 7),
                                 rep("Intervention",
                                     length(nm)-7)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est <- do.call('rbind', est)

fig3A <- ggplot(data = est,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 24, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16,
                                   color = 'black'),
        legend.title = element_text(size = 16,
                                   color = 'black'),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = labels.order.abb) +
  scale_x_continuous(breaks = seq(0.5, 1.3, 0.1),
                     labels = c('-50', '-40', '-30', 
                                '-20', '-10', '0', '10', '20', '30'),
                     limits = c(0.5, 1.3),
                     expand = c(0, 0))

fig3A

est.out = data.frame(intervention = rev(intv.order),
                     stringsAsFactors = FALSE)

gee.out = left_join(est.out, est[est$Model == 'GEE', 
                                 c('intervention',
                                   'coefficients', 
                                   'ci.lower', 
                                   'ci.upper')])
gee.out$est = paste(sprintf('%.02f', 1 - gee.out$coefficients),
                    ' (',
                    sprintf('%.02f', 1 - gee.out$ci.upper),
                    ', ',
                    sprintf('%.02f', 1 - gee.out$ci.lower),
                    ')',
                    sep = '')

ll.out = left_join(est.out, est[est$Model == 'Log-linear', 
                                 c('intervention',
                                   'coefficients', 
                                   'ci.lower', 
                                   'ci.upper')])
ll.out$est = paste(sprintf('%.02f', 1 - ll.out$coefficients),
                    ' (',
                    sprintf('%.02f', 1 - ll.out$ci.upper),
                    ', ',
                    sprintf('%.02f', 1 - ll.out$ci.lower),
                    ')',
                    sep = '')

write.csv(gee.out,
          'output/table_fig_3a_gee.csv',
          row.names = FALSE)
write.csv(ll.out,
          'output/table_fig_3a _ll.csv',
          row.names = FALSE)

```

## Fig. 3c: Drop one intervention

```{r drop intervention analyis, echo=FALSE, fig.width=10, fig.height=6.5}

dropInterventionModelFit = function(dat, models){
  
  # settings
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      'log10_popdense'),
                  state_interventions = colnames(data.google)[intv.colums])
  predictors = unlist(predictors)
  
  data.used = dat[rowSums(is.na(dat[ ,c(predictors, 'log_Rt_previous', 'weights', 'state_name')])) == 0, ]
  
  tem = lapply(predictors, function(x){
  
    x.used = predictors[!(predictors %in% x)]
    
    fml.log <-  paste('log_Rt ~ ',
                      paste(x.used,
                            collapse = " + "),
                      '+ log_Rt_previous + state_name',
                      sep = "")
      
    fml.used <- as.formula(fml.log)
    
    m = lm(fml.used,
           weights = weights,
           data = data.used)
    
    tem = data.frame(intervention = predictors,
                     dropped.variable = x, 
                     coef.main = coef(models$lmMain)[predictors],
                     coef.drop = coef(m)[predictors],
                     stringsAsFactors = FALSE)

    tem$coef.diff = tem$coef.main - tem$coef.drop
      
    return(tem)
    
  })
  
  tem = do.call('rbind', tem)
  
  tem$risk.chage = 10^(tem$coef.diff)
  
  return(tem)

}

estDropIntervention = dropInterventionModelFit(dat, models)
estDropIntervention$intervention = factor(estDropIntervention$intervention,
                                          levels = levels(melt_mat$var))
estDropIntervention$dropped.variable = factor(estDropIntervention$dropped.variable,
                                              levels = levels(melt_mat$var))

fig3C <- ggplot(data = estDropIntervention, 
                aes(x = dropped.variable, 
                    y = intervention, 
                    fill = risk.chage)) +
  geom_tile(color = "black", size = 0.2) +
  scale_fill_gradient2(low = "#0392cf", high = "#ee4035", mid = "white",
                       midpoint = 1, 
                       limit = c(0.85, 1.25), 
                       space = "Lab",
                       name="Original to the dropped\n model",
                       labels = c('0.85', '', '', '', '1.25')) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   size = 16, 
                                   hjust = 1,
                                   color = 'black'),
       axis.text.y = element_text(size = 14,
                                   color = 'black'),
       # axis.text.y = element_blank(),
       axis.title.x = element_text(size = 16,
                                    face = 'bold'),
       axis.title.y = element_text(size = 16, 
                                    face = 'bold'),
        plot.title = element_text(size = 24, 
                                  face = 'bold'),
       # plot.margin = unit(c(1,1,1,1), "cm"),
       plot.title.position = "plot",
       legend.text = element_text(size = 16),
       legend.title = element_text(size = 16),
       legend.position = 'top') +
 coord_fixed() +
   labs(title = "c",
       x = "Dropped intervention",
       y = "") +
  scale_y_discrete(labels = labels.abb) +
  scale_x_discrete(labels = labels.abb)

fig3C

```

# figure 3 output
```{r fig 3, echo=FALSE, fig.width=12, fig.height=18, warning=FALSE, message=FALSE, fig.align='center'}

# jpeg('output/plot/fig_3.jpeg', width = 20*600, height = 8.3*600, res = 600)
pdf('output/plot/fig_3.pdf', width = 20, height = 8.3)

ggarrange(fig3A,
          fig3B,
          fig3C,
          heights = 6,
          widths = c(10, 4, 8),
          nrow = 1,
          align = "h")

dev.off()


```


# Figure 4

## Data for intervention combinations
```{r data for intervention suites, include=FALSE}

intv.comb = data.google[ ,c('FIPS', 'Date', interventions)]
intv.comb = intv.comb[rowSums(is.na(intv.comb[, interventions])) == 0, ]
intv.comb$combination = sapply(1:nrow(intv.comb), function(x) paste(intv.comb[x ,interventions],
                                                                    collapse = ''))
data.google = left_join(data.google, intv.comb)

comb.order = data.frame(table(intv.comb$combination),
                        stringsAsFactors = FALSE)
colnames(comb.order) = c('combination', 'freq')
comb.order = comb.order[order(-comb.order$freq), ]
comb.order$combination = as.character(comb.order$combination)
comb.order$proportion = round(comb.order$freq/sum(comb.order$freq)*100, 1)

comb.rt = unique(intv.comb[ ,c('combination', interventions)])
comb.order = left_join(comb.order, comb.rt)

comb.order.sub = comb.order[c(1:11, 25),]
comb.order.sub$nIntv = rowSums(comb.order.sub[ ,interventions])
comb.order.sub = comb.order.sub[order(comb.order.sub$nIntv), -ncol(comb.order.sub)]


coeff = summary(models$main)$coefficients[interventions, ]

comb.order.sub$chagnes = sapply(1:nrow(comb.order.sub), function(i) sum(comb.order.sub[i, interventions] * coeff[ ,1]))

dat.new = data.google
dat.new = dat.new[ ,!(colnames(dat.new) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat.new = dat.new[rowSums(is.na(dat.new)) == 0, ] # to make sure all analyses used the same dataset
dat.new[ ,interventions] = 0

pred = predict(models$main, newdata = dat.new)
rt.range = quantile(10^pred,
                    c(.025, .25, .5, .75, .975))

smr.mat = t(sapply(1:nrow(comb.order.sub), function(x) {
  
  dat.new.used = dat.new
  
  for(i in interventions){
    
    dat.new.used[ ,i] = comb.order.sub[x, i]
    
  }
  
  pred = predict(models$main, newdata = dat.new.used)
  
  quantile(10^pred,
                    c(.025, .25, .5, .75, .975))
  
}))

colnames(smr.mat) = paste('Rt', c(2.5, 25, 50, 75, 97.5), sep = '_')

comb.order.sub = cbind(comb.order.sub, smr.mat)


```

```{r data for intervention suites subset, include=FALSE}

combnations = paste('combination',
                    as.character(comb.order.sub$combination[!is.na(comb.order.sub$freq)]),
                    sep = '')

data.fig4 = data.google[!is.na(data.google$combination), ]

dummy.comb = model.matrix(~ 0 + combination, data = data.fig4)
dummy.comb = dummy.comb[ ,colnames(dummy.comb) %in% combnations]

data.fig4 = cbind(data.fig4,
                 dummy.comb)

write.csv(data.fig4,
          'data/data_for_fig4.csv',
          row.names = FALSE)



```

## Fit GEE regression
```{r intervention suites fit gee, include=FALSE}

fitModelCombinations = function(dat){
  
  fml = as.formula('log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + combination')
  
  dat.used = dat[rowSums(is.na(dat[ ,c('log_Rt',
                                       'log10_popsize',
                                       'med_income',
                                       'percent_poverty',
                                       'med_age',
                                       'prop_white',
                                       'prop_belowCollege',
                                       'log10_popdense',
                                       'state_name')])) == 0, ]
  
  dat.used$week = factor(dat.used$week)
  
  geeglm(fml,
         id = FIPS,
         corstr = 'ar1',
         weights = weights,
         data = dat.used)
  
}

model.suites = fitModelCombinations(dat = data.fig4)

est.suites = t(sapply(1:nrow(comb.order.sub), function(x) {
  
  dat.new.used = dat.new
  
  dat.new.used$combination = comb.order.sub$combination[x]
  
  pred = predict(model.suites, 
                 newdata = dat.new.used)
  
  quantile(10^pred,
                    c(.025, .25, .5, .75, .975))
  
}))

colnames(est.suites) = c('suite_025',
                         'suite_25',
                         'suite_50',
                         'suite_75',
                         'suite_975')

comb.order.sub = cbind(comb.order.sub,
                           est.suites)


comb.order.sub = rbind(comb.order.sub,
                       comb.order.sub[1:2, ])
comb.order.sub[(nrow(comb.order.sub)-1):nrow(comb.order.sub), 1] = c('1234567',
                                                                     '7654321')
comb.order.sub[(nrow(comb.order.sub)-1):nrow(comb.order.sub), 
               2:ncol(comb.order.sub)] = NA


comb.order.sub = comb.order.sub[c(1,
                                  13,
                                  2:11,
                                  14, 
                                  12),]

comb.order.sub$combination = factor(comb.order.sub$combination,
                                    levels = comb.order.sub$combination)

melt.comb.order = melt(comb.order.sub[ ,c('combination', interventions)])


comb.order.sub$proportion = sprintf('%.1f', comb.order.sub$proportion)
comb.order.sub$proportion = paste(comb.order.sub$proportion, '%', sep = '')
comb.order.sub$proportion[grepl('NA', comb.order.sub$proportion)] = ''

x.label = sapply(1:nrow(comb.order.sub), function(x) paste("'",
                                                 comb.order.sub$combination[x],
                                                 "' = '",
                                                 comb.order.sub$proportion[x],
                                                 "'",
                                                 sep = ''))

```

## Combine with estimates from XGBoost
```{r intervention suites xgboost, include=FALSE}

xgboost = read.csv('data/xgboost_suiteRt_deconv.csv',
                   header = TRUE, 
                   stringsAsFactors = FALSE)

xgboost$combination = sapply(1:nrow(xgboost), function(x) paste(xgboost[ x,1:length(interventions)],
                            collapse = ''))

colnames(xgboost)[9:14] = c('xg_025',
                            'xg_25',
                            'xg_50',
                            'xg_75',
                            'xg_975',
                            'xg_100')

comb.order.sub = left_join(comb.order.sub, 
                           xgboost[ ,c('combination',
                                       'xg_025',
                                       'xg_25',
                                       'xg_50',
                                       'xg_75',
                                       'xg_975')])



```

## figure 4 output
```{r Fig 4, echo=FALSE, fig.width=9, fig.height=14, warning=FALSE, message=FALSE, fig.align='center'}

fig4A = ggplot(data = melt.comb.order,
                        aes(x = factor(combination,
                                       levels = comb.order.sub$combination),
                            y = factor(variable,
                                       levels = intv.order),
                            fill = factor(value))) +
  geom_tile(color = "white",
            width = 0.9,
            height = 0.9)  +
  labs(title="a",
       x="", 
       y = "") +
  scale_fill_manual("Implemention",
                    labels = c('No', "Yes", ''),
                    values = c("#0392cf", "#ee4035", 'white'),
                    na.value = 'white') +
  theme_bw() +
  theme(axis.text.x = element_text(size = 16, color = grey(0.5)),
        axis.text.y = element_text(size = 16, color = 'black'),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16),
        axis.ticks = element_blank(),
        panel.border = element_rect(fill = NA, color = "white", size = 2)) +
  scale_y_discrete(labels = labels.order) +
  scale_x_discrete(labels = comb.order.sub$proportion)

comb.order.sub$combination = factor(comb.order.sub$combination,
                                    levels = comb.order.sub$combination)

fig4B = ggplot(data = comb.order.sub %>% mutate(xn=as.numeric(combination)),
                aes(x = xn - 0.3,
                    y = suite_50,
                    color = )) +
  
  geom_hline(yintercept = 1,
             color = 'black',
             linetype = 'dashed') +
  
  
  geom_errorbar(aes(x = xn - 0.5,
                    ymin=suite_025,
                    ymax=suite_25,
                    color = 'GEE suite'), 
                width = 0.12,
                alpha = 1,
                size = 0.4) +
  geom_errorbar(aes(x = xn - 0.5,
                    ymin=suite_75,
                    ymax=suite_975,
                    color = 'GEE suite'), 
                width = 0.12,
                alpha = 1,
                size = 0.4) +
  geom_rect(data = comb.order.sub %>% mutate(xn=as.numeric(combination)),
            aes(xmin = xn - 0.05 - 0.5,
                xmax = xn + 0.05 - 0.5,
                ymin = suite_25,
                ymax = suite_75,
                color = 'GEE suite'),
            alpha = 0.3, 
            fill = 'white',
            size = 0.4) + 
    geom_segment(aes(x = xn - 0.05 - 0.5,
                     y = suite_50,
                     xend = xn + 0.05 - 0.5,
                     yend = suite_50,
                     color = 'GEE suite'),
                 size = 1) + 
  
  geom_errorbar(aes(x = xn - 0.7,
                    ymin=Rt_2.5,
                    ymax=Rt_25,
                    color = 'GEE individual'),
                width = 0.12,
                alpha = 1,
                size = 0.4) +
    geom_errorbar(aes(x = xn - 0.7,
                    ymin=Rt_97.5,
                    ymax=Rt_75,
                    color = 'GEE individual'),
                width = 0.12,
                alpha = 1,
                size = 0.4) +
    geom_rect(data = comb.order.sub %>% mutate(xn=as.numeric(combination)),
            aes(xmin = xn - 0.05 - 0.7,
                xmax = xn + 0.05 - 0.7,
                ymin = Rt_25,
                ymax = Rt_75,
                color = 'GEE individual'),
            alpha = 0.3,
            fill = 'white',
            size = 0.4) +
    geom_segment(aes(x = xn - 0.05 - 0.7,
                     y = Rt_50,
                     xend = xn + 0.05 - 0.7,
                     yend = Rt_50,
                     color = 'GEE individual'),
                 size = 1) + 

  geom_errorbar(aes(x = xn - 0.3,
                    ymin=xg_025,
                    ymax=xg_25,
                    color = 'XGBoost individual'),
                width = 0.12,
                alpha = 1,
                size = 0.4) +
    geom_errorbar(aes(x = xn - 0.3,
                    ymin=xg_975,
                    ymax=xg_75,
                    color = 'XGBoost individual'),
                width = 0.12,
                alpha = 1,
                size = 0.4) +
  geom_rect(data = comb.order.sub %>% mutate(xn=as.numeric(combination)),
            aes(xmin = xn - 0.05 - 0.3,
                xmax = xn + 0.05 - 0.3,
                ymin = xg_25,
                ymax = xg_75,
                color = 'XGBoost individual'),
            fill = 'white',
            alpha = 0.3, 
            size = 0.4) + 
  geom_segment(data = comb.order.sub %>% mutate(xn=as.numeric(combination)),
               aes(x = xn - 0.05 - 0.3,
                   y = xg_50,
                   xend = xn + 0.05 - 0.3,
                   yend = xg_50,
                 color = 'XGBoost individual'),
             size = 1) + 

  labs(# y = 'Rt',
       y = expression(R[eff]),
       x = 'Combination of non-pharmaceutical interventions',
       title = 'b') +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16, color = 'black'),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold',
                                    margin = margin(t = 0, r = 20, b = 0, l = 0)),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16)) +
  scale_y_continuous(breaks = c(0.3, 0.5, 1, 2, 5, 8),
                     limits = c(0.3, 10),
                     trans = 'log10',
                     labels = c(0.3, 0.5, 1, 2, 5, 8)) +
  scale_color_manual(name = '',
                     values = c('GEE individual' = '#d9534f',
                                'GEE suite' = '#82312f', 
                                'XGBoost individual' = '#a183ac'))

# jpeg("output/plot/fig_4.jpeg",
#      width = 12*600, height = 9*600, res = 600)
pdf("output/plot/fig_4.pdf",
     width = 12, height = 9)
ggarrange(fig4A,
          fig4B,
          nrow = 2,
          align = 'v')
dev.off()


```

## Table of estimates in figure 4
```{r Fig 4 table, include=FALSE}

rows = c(1, 3:10, 12)
table_fig4 = comb.order.sub[rows, c('combination', 
                                    'proportion',
                                    interventions)]

table_fig4$gee_individual = paste(sprintf('%.02f', comb.order.sub[rows, 'Rt_50']),
                                  ' (',
                                  sprintf('%.02f', comb.order.sub[rows, 'Rt_2.5']),
                                  ', ',
                                  sprintf('%.02f', comb.order.sub[rows, 'Rt_97.5']),
                                  ')',
                                  sep = '')

table_fig4$gee_suite = paste(sprintf('%.02f', comb.order.sub[rows, 'suite_50']),
                                  ' (',
                                  sprintf('%.02f', comb.order.sub[rows, 'suite_025']),
                                  ', ',
                                  sprintf('%.02f', comb.order.sub[rows, 'suite_975']),
                                  ')',
                                  sep = '')

table_fig4$xgboost = paste(sprintf('%.02f', comb.order.sub[rows, 'xg_50']),
                                  ' (',
                                  sprintf('%.02f', comb.order.sub[rows, 'xg_025']),
                                  ', ',
                                  sprintf('%.02f', comb.order.sub[rows, 'xg_975']),
                                  ')',
                                  sep = '')

write.csv(table_fig4,
          'output/table_figure_4.csv',
          row.names = FALSE)


```


# Figure S1 - Map of weekly Rt

```{r fig s1, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE}

figS1 = lapply(weeks_dates, countyMapPlot, county_rt = county_rt, supp = TRUE)

# jpeg('output/plot/fig_s1.jpeg',
#     width = 24*600, height = 18*600, res = 600)
pdf('output/plot/fig_s1.pdf',
    width = 24, height = 18)
grid.arrange(grobs = figS1,
             ncol = 5,
             nrow = 4)
dev.off()


```

# Figure S2 - Grouping

```{r fig s2, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE}

# Import and process raw intervention data. Then, cluster to guide grouping interventions based on their co-occurrences.
source("intervention_processing.R")

```

# Figure S3 - Temporal distribution of intervention and by state
```{r fig s3, echo=FALSE, fig.width=15, fig.height=22, warning=FALSE, message=FALSE, fig.align='center'}

melt_intervention = data.google[, c("Date", 'state_name',interventions)] %>% gather(intervention, implemention, -Date:-state_name)
melt_intervention = melt_intervention[!is.na(melt_intervention$implemention), ]
melt_intervention$intervention = factor(melt_intervention$intervention,
                                        levels = c('state_of_emergency',
                                       'lv3_stay_home',
                                       'lifestyle_close',
                                       'daycare_close',
                                       'earliest_date_school_closed',
                                       'ban_nursing_home_visit',
                                       'suspend_medical',
                                       'face_mask'))

new.labels = c("state_of_emergency" = 'State of emergency',
               "lv3_stay_home" = 'Stay at home',
               "lifestyle_close" = 'Leisure activities closure',
               "daycare_close" = 'Daycare closure',
               "earliest_date_school_closed" = 'School closure',
               "ban_nursing_home_visit" = 'Nursing home visit ban',
               "face_mask" = 'Face mask',
               "suspend_medical" = 'Medical service suspensions')

# jpeg('output/plot/fig_s3.jpeg',
#      width = 26*600, height = 19*500, res = 600)
pdf('output/plot/fig_s3.pdf',
     width = 26, height = 19)
ggplot(data = melt_intervention,
                        aes(x = factor(Date),
                            y = reorder(state_name,
                                        desc(state_name)),
                            fill = factor(implemention))) +
  geom_tile(color = "white",
            width = 0.9,
            height = 0.9)  +
  labs(title="",
       x="",
       y = "") +
  scale_fill_manual("Implemention",
                    labels = c('No', "Yes"),
                    values = c("#4eb2dd", "#f48c85")) +
                    # values = c('#4c516d', "#e3a857")) +
  facet_wrap(.~ intervention,
             labeller = labeller(intervention = new.labels),
             nrow = 2) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = 90, hjust = 1),
        axis.text.y = element_text(size = 14),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 16),
        plot.title = element_text(size = 16),
        strip.background = element_blank(),
        panel.grid = element_line(color = "#fafafa"),
        axis.ticks = element_blank(),
        panel.border = element_rect(fill = NA, color = "white", size = 2),
        strip.text = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16, face = "bold"))
  
dev.off()

```

# Figure S4 - Rt and intervention by state

```{r fig s4, echo=FALSE, fig.width=18, fig.height=14, warning=FALSE}

# generic settings
y.lim <- c(0, 12)
colours <- c("#38a1db", "#abda00", "#2859b8",
             "#053853", "#6766cc", "#7301ed", '#98dce8')
names(colours) <- interventions

# data
y.pos <- seq(y.lim[1] + 1.5,
             y.lim[2] - 1.5,
             length.out = length(interventions))

data.google$Date <- as.Date(data.google$Date,
                     '%Y-%m-%d')
data.narrow <- data.google[ ,c('Date', 'Rt_mean',
                        'state_name', 'county',
                        interventions)]
data.int <- lapply(1:length(y.pos), function(i){ # assing positions

  y <- rep(NA, nrow(data.google))
  y[data.google[,interventions[i]]>0] <- y.pos[i]
  y

})


data.int <- do.call('cbind', data.int)
colnames(data.int) <- interventions

data.narrow[ ,5:ncol(data.narrow)] <- data.int

figS4 <- ggplot(data.narrow, aes(x = Date,
                             y = Rt_mean,
                             group = county)) +
    geom_point(color = "black", alpha = 0.2) +
  geom_line(color = "black", alpha = 0.2) +
  facet_wrap(~ state_name,
             scales = 'free_x',
             nrow = 8) +
  geom_segment( data = data.narrow %>%
      gather(intervention, val, -Date:-county), 
      aes(x = Date,
          xend = max(Date),
          y = val,
          yend = val,
          color = intervention), 
      alpha = 0.4,
      size = 1.2) +
  ylim(y.lim[1], y.lim[2]-0.5) +
  theme_classic() +
  theme(
    legend.position = 'bottom',
    strip.background = element_blank(),
    strip.text = element_text(size = 20, face = "bold"),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16, face = 'bold'),
    legend.key.size = unit(2, 'line'),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold")
  ) +
  geom_hline(yintercept = 1,
             linetype = 'dashed',
             color = 'red') +
  labs(x = '',
       y = expression(paste('Weekly R'[eff]))) +
  scale_colour_manual(name = 'Intervention',
                      values = colours,
                      labels = c("Daycare closure",
                                 "Face mask",
                                 "Leisure activities closure",
                                 "Stay at home",
                                 "Nursing home visit ban",
                                 "Medical service suspensions",
                                 "School closure")) +
  scale_x_continuous(limits = as.Date(c('2020-01-15',
                                        '2020-07-01'),
                                      '%Y-%m-%d'),
                     breaks = as.Date(c('2020-01-15',
                                        '2020-02-01',
                                        '2020-03-01',
                                        '2020-04-01',
                                        '2020-05-01',
                                        '2020-06-01',
                                        '2020-07-01'),
                                      '%Y-%m-%d'),
                     labels = c('', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'))

# jpeg("output/plot/fig_s4.jpeg", width = 22*600, height = 20*600, res = 600)
pdf("output/plot/fig_s4.pdf", width = 22, height = 20)
figS4
dev.off()

```

# Figure S5 - ACF
## ACF of residuals from OLS model without autoregressive
```{r fig s5, echo=FALSE, fig.width=12, fig.height=6, warning=FALSE, message=FALSE}

getAcfFromLm = function(dat){
  
  # settings
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      "med_age",
                                      "prop_white",
                                      "prop_belowCollege",
                                      "log10_popdense"),
                  state_interventions = colnames(dat)[intv.colums],
                  state = "state_name",
                  county_time = c(colnames(a)[-1], 'time_since_national_start'),
                  autoregressive = "log_Rt_previous")
  
  model.predictors = c('county_census',
                       'state_interventions',
                       'state')
  
  xs = unlist(sapply(model.predictors, function(x) predictors[[x]]))
  data.used = dat[rowSums(is.na(dat[ ,c(xs, 'log_Rt', 'weights')])) == 0, ]
  
  
  fml.log <-  paste('log_Rt ~ ',
                    paste(xs, collapse = " + "),
                    sep = "")
  
  fml.used <- as.formula(fml.log)

  m = lm(fml.used,
           weights = weights,
           data = data.used)
  
  data.used$pred = residuals(m, newdata = data.used)
  
  data.used = data.used[order(data.used$Date), ]
  # calculate acf
  
  acfByCounty = lapply(unique(data.used$FIPS), function(i){
    
    ts = data.used$pred[data.used$FIPS == i]
    
    tem = acf(ts,
             lag = 1,
             plot = FALSE)
    
    threshold = qnorm(0.975)/(sqrt(length(ts)))
    
    corr = tem$acf[2]
    
    df = data.frame(FIPS = i,
                    acf = corr,
                    threshold = threshold,
                    autocorrelation = abs(corr) > threshold,
                    stringsAsFactors = FALSE)
    
  })
  
  acfByCounty = do.call('rbind', acfByCounty)
  
  return(acfByCounty)

}

acfByCounty = getAcfFromLm(dat)

figs5 = ggplot(data = acfByCounty,
       aes(x = acf)) +
  geom_histogram(color = grey(0.5),
                 fill = 'white',
                 binwidth = 0.1) +
  theme_classic() +
  labs(title = "Distribution of county ACF",
       y = 'Count',
       x = 'ACF, lag = 1') +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(limits = c(-1, 1),
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 500),
                     expand = c(0, 0))

jpeg('output/plot/fig_s5.jpeg', width = 10*600, height = 8.3*600, res = 600)
# pdf('output/plot/fig_s5.pdf', width = 10, height = 8.3)
figs5
dev.off()
  

```

# Figure S6 - Regression with post interventions
```{r fig s6, echo=FALSE, fig.width=10, fig.height=6.5}

postModelFit = function(dat, interventions_post, model){
  
  # remove interventions has not been lifted
  tem = colSums(dat[ ,interventions_post], na.rm = TRUE)
  interventions_used = interventions_post[tem > 0]
  interventions_used = interventions_used[!(interventions_used %in% c("state_of_emergency_pre",
                                                                      "state_of_emergency_implement",
                                                                      "earliest_date_school_closed_pre"))]
    interventions_used = interventions_used[!grepl("_pre", interventions_used)]
  
      variables = c('log10_popsize',
                    'med_income',
                    'percent_poverty',
                    'log10_popdense',
                    'med_age',
                    'prop_white',
                    'prop_belowCollege',
                interventions_used)
    
    if(model == 'GEE'){
      
      fml = as.formula(paste('log_Rt ~ log10_popsize + med_income + percent_poverty + log10_popdense + med_age + prop_white + prop_belowCollege + state_name',
                         paste(interventions_used,
                         collapse = " + "),
                         sep = " + "))
      
      m = geeglm(fml, 
                 id = FIPS,
                 weights = weights, 
                 corstr = 'ar1',
                 data = dat)
      
      coeff = summary(m)$coefficients[variables, ]
      ci = cbind(coeff[ ,1] - 1.96*coeff[ ,2],
                 coeff[ ,1] + 1.96*coeff[ ,2])
      
      tab = data.frame(interventions = variables,
                       coefficients = 10^(coeff[ ,1]),
                       ci.lower = 10^(ci[, 1]),
                       ci.upper = 10^(ci[, 2]),
                       Model = model,
                       stringsAsFactors = FALSE)
      
    }
    if(model == 'Log-linear'){
      
      fml = as.formula(paste('log_Rt ~ log_Rt_previous + log10_popsize + med_income + percent_poverty + log10_popdense + med_age + prop_white + prop_belowCollege + state_name',
                         paste(interventions_used,
                         collapse = " + "),
                         sep = " + "))
      
      m = lm(fml, 
             weights = weights, 
             data = dat)
      
      tab = data.frame(interventions = variables,
                       coefficients = 10^(coef(m))[variables],
                       ci.lower = 10^(confint(m)[variables, 1]),
                       ci.upper = 10^(confint(m)[variables, 2]),
                       Model = model,
                       stringsAsFactors = FALSE)
      
    }
      
  return(tab)

}

postEst = lapply(c('GEE', 'Log-linear'), function(model) {
  postModelFit(dat = dat,
               interventions_post = interventions_post,
               model = model)
})

postEst = do.call('rbind', postEst)

postEst$Model[postEst$Model == 'Log-linear'] = 'OLS'

IntLabels = c('log10_popsize' = 'Log population size',
              'med_income' = 'Median income',
              'percent_poverty' = 'Decile of poverty',
              'log10_popdense' = 'Log population density',
              'med_age' = 'Median age',
              'prop_white' = 'Decile of white',
              'prop_belowCollege' = 'Decile of below college',
              
              'suspend_medical_post' = 'Medical service suspension off',
              'suspend_medical_implement' = 'Medical service suspension on',
              
              'face_mask_implement' = 'Face mask on',
              
              'ban_nursing_home_visit_implement' = 'Nursing home visit ban on',
              
              'daycare_close_implement' = 'Daycare closure on',
              
              'lv3_stay_home_post' = 'Stay at home off',
              'lv3_stay_home_implement' = 'Stay at home on',
              
              'lifestyle_close_post' = 'Leisure activities closure off',
              'lifestyle_close_implement' = 'Leisure activities closure on',
              
              'earliest_date_school_closed_implement' = 'School closure on')

pPost <- ggplot(data = postEst,
                aes(y = factor(interventions,
                               levels = names(IntLabels)),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "")+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'right') +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = IntLabels) +
  annotate("rect", 
           xmin = -Inf, 
           xmax = Inf, 
           ymin = 7.8, 
           ymax = 9.3,
           alpha = .2) +
  annotate("rect", 
           xmin = -Inf, 
           xmax = Inf, 
           ymin = 12.8, 
           ymax = 14.3,
           alpha = .2) +
  annotate("rect", 
           xmin = -Inf, 
           xmax = Inf, 
           ymin = 14.8, 
           ymax = 16.3,
           alpha = .2) +
scale_x_continuous(breaks = seq(0.6, 1.4, 0.1),
                       labels = c( '-40', '-30', 
                                  '-20', '-10', '0',
                                  '10', '20', '30', '40'), limits = c(0.5, 1.4))

# jpeg("output/plot/fig_s6.jpeg",
#      width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s6.pdf",
     width = 10, height = 7.5)
pPost
dev.off()

```

# Fgiure S7 - Analysis with calendar time, proxied by weeks since first case in US

```{r fig s7, echo=FALSE, fig.width=8, fig.height=5}

est.time.country <- lapply(c('main', 'countryTimeIntv', 
                             'lmMain', 'lmCountryTimeIntv'),
              function(model){

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model %in% c('main', 'lmCountryTimeIntv')){type = 'GEE'} else {type = 'Log-linear'}
  if(model %in% c('main', 'lmMain')){time = 'No'} else {time = 'Yes'}

  esti = summary(models[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   Time = time,
                   variables = c(rep("Census", 3),
                                 rep("Intervention",
                                     length(nm)-3)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.time.country <- do.call('rbind', est.time.country)

pCompCountryTimeGee <- ggplot(data = est.time.country[est.time.country$Model == 'GEE', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = c(0.5, 0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('', '-40', '-20', '0', '20', '40'),
                     limits = c(0.5, 1.4),
                     expand = c(0, 0)) +
  scale_color_manual(name = "Time",
                     values = c( "#d9534f", "#083765")) +
  scale_y_discrete(labels = labels.order)


pCompCountryTimeLL <- ggplot(data = est.time.country[est.time.country$Model == 'Log-linear', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'b')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = c(0.5, 0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('', '-40', '-20', '0', '20', '40'),
                     limits = c(0.5, 1.4),
                     expand = c(0, 0)) + 
  scale_color_manual(name = "Time",
                     values = c( "#3baee5", "#650837")) +
  scale_y_discrete(labels = labels.order)


# jpeg('output/plot/fig_s7.jpeg',
#      width = 16*600, height = 6*600, res = 600)
pdf('output/plot/fig_s7.pdf',
     width = 16, height = 6)
grid.arrange(pCompCountryTimeGee,
             pCompCountryTimeLL,
             nrow = 1)
dev.off()

```

# Fgiure S9 - split CDC guideline week from school closure

```{r fig s9 - fit model, echo=FALSE, fig.width=12, fig.height=6, warning=FALSE, message=FALSE, include=FALSE}

datCDC = data.google
datCDC = datCDC[ ,!(colnames(datCDC) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
datCDC = datCDC[rowSums(is.na(datCDC)) == 0, ] # to make sure all analyses used the same dataset

country_weeks = dummy(datCDC$time_since_national_start, sep = '_')
colnames(country_weeks) = paste('country_week', 6:21, sep = '_')

a = dummy(data.google$week, sep = '_')
colnames(a) = paste('week', -2:13, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))

datCDC$earliest_date_school_closed[datCDC$Date == as.Date('2020-03-21')] = 2
datCDC$earliest_date_school_closed = factor(datCDC$earliest_date_school_closed,
                                         levels = 0:2)
  
modelFitCDC = function(model, dat, stateLevel){
  
  print(model)
  
  if(stateLevel){
    
    state_interventions = c("daycare_close",
                            "face_mask",
                            "lifestyle_close",
                            "lv3_stay_home",
                            "ban_nursing_home_visit",
                            "suspend_medical",
                            "earliest_date_school_closed")
    
  } else {
    
    state_interventions = colnames(data.google)[intv.colums]
    
  }
  
  # set up
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      "log10_popdense"),
                    
                    state_interventions = state_interventions,
                    
                    state = "state_name",
                  
                    county_time = c(colnames(a)[3:ncol(a)]),
                    
                    country_time = c(colnames(country_weeks)[2:ncol(country_weeks)]),
                  
                    autoregressive = "log_Rt_previous")
  
  model.types = list(main = 'GEE', 
                     base = 'GEE', 
                     timeOnly = 'GEE',
                     timeIntv = 'GEE', 
                     
                     lmMain = 'Linear',
                     lmBase = 'Linear',
                     lmTimeOnly = 'Linear',
                     lmTimeIntv = 'Linear', 
                     
                     lassoMain = 'LASSO',
                     lassoTime = 'LASSO',
                     lassoIntv = 'LASSO',
                     
                     countryTimeIntv = 'GEE',
                     lmCountryTimeIntv = 'Linear')
  
  model.predictors = list(main = c('county_census',
                                   'state_interventions',
                                   'state'),
                        
                          base = c('county_census',
                                   'state'),
                        
                          timeOnly = c('county_time',
                                       'county_census',
                                       'state'),
                        
                          timeIntv = c('state_interventions',
                                       'county_time',
                                       'county_census',
                                       'state'),
                        
                          lmMain = c('autoregressive',
                                     'county_census',
                                     'state_interventions',
                                     'state'),
                                                    
                          lmBase = c('autoregressive',
                                     'county_census',
                                     'state'),
                        
                          lmTimeOnly = c('autoregressive',
                                         'county_time',
                                         'county_census',
                                         'state'),
                        
                          lmTimeIntv = c('autoregressive',
                                         'state_interventions',
                                         'county_time',
                                         'county_census',
                                         'state'),
                          
                          lassoMain = c('autoregressive',
                                        'county_census',
                                        'state_interventions',
                                        'state'),
                        
                          lassoTime = c('autoregressive',
                                        'county_census',
                                        'state'),
                        
                          lassoIntv = c('county_census',
                                        'state_interventions',
                                        'state'),
                          
                          countryTimeIntv = c('state_interventions',
                                              'country_time',
                                              'county_census',
                                              'state'),
                          
                          lmCountryTimeIntv = c('autoregressive',
                                                'state_interventions',
                                                'country_time',
                                                'county_census',
                                                'state'))
  
  xs = unlist(sapply(model.predictors[[model]], function(x) predictors[[x]]))
  
  fml.log <-  paste('log_Rt ~ ',
                    paste(xs, collapse = " + "),
                    sep = "")
  
  fml.used <- as.formula(fml.log)

  if(model.types[[model]] == 'Linear'){

    m = lm(fml.used,
           weights = weights,
           data = dat)

  }

  if(model.types[[model]] == 'GEE'){

    m = geeglm(fml.used,
                data = dat,
                id = FIPS,
                corstr = "ar1",
                weights = weights)



  }

  if(model.types[model][[1]] == 'LASSO'){

    lambda = seq(0, 0.1, 0.005)

    x = model.matrix(log_Rt ~ .-1,
                     dat[ ,c(xs,
                                   'log_Rt')])
    y = dat$log_Rt
    w = dat$weights

    m = glmnet(x,
               y,
               alpha = 1,
               lambda = lambda,
               weights = w)

  }

  return(m)

}

modelsCDC = lapply(c("main",
                       
                       "lmMain"
                       ),
                     modelFitCDC,
                     dat = datCDC,
                     stateLevel = TRUE)

names(modelsCDC) = c("main",
                  
                       "lmMain")


```

```{r fig s9, echo=FALSE, fig.width=8, fig.height=5}

estCDC <- lapply(c('main', 'lmMain'),
              function(model){# 1 = gee; 2 = log-lm

 nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed1",
         'earliest_date_school_closed2',
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model == 'main'){type = 'GEE'} else {type = 'OLS'}

  esti = summary(modelsCDC[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   variables = c(rep("Census", 7),
                                 rep("Intervention",
                                     length(nm)-7)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

estCDC <- do.call('rbind', estCDC)

intv.order.cdc = intv.order
intv.order.cdc[15] = 'earliest_date_school_closed1'
intv.order.cdc = c(intv.order.cdc, 'earliest_date_school_closed2')

labels.order.cdc =labels.order
labels.order.cdc =  c(labels.order.cdc, labels.order.cdc[15])
labels.order.cdc[15:16] = c("School closure (after CDC guideline issued)",
                            "School closure (week of CDC guideline issued)")
names(labels.order.cdc)[15:16] = c("earliest_date_school_closed1",
                                   "earliest_date_school_closed2")



fig3ACDC <- ggplot(data = estCDC,
                aes(y = factor(intervention,
                               levels = intv.order.cdc),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = '')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16,
                                   color = 'black'),
        legend.title = element_text(size = 16,
                                   color = 'black'),
        plot.margin = unit(c(1,1,1,1), 'cm')) +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = labels.order.cdc) +
  scale_x_continuous(breaks = seq(0.4, 1.3, 0.1),
                     labels = c('-60', '-50', '-40', '-30', 
                                '-20', '-10', '0', '10', '20', '30'),
                     limits = c(0.4, 1.3),
                     expand = c(0, 0))

fig3ACDC


# jpeg('output/plot/fig_s9.jpeg', width = 10*600, height = 8.3*600, res = 600)
pdf('output/plot/fig_s9.pdf', width = 10, height = 8.3)
fig3ACDC
dev.off()

```

# Figure S10 - Multiple interventions vs. Single intervention

```{r fig s10, echo=FALSE, fig.width=8, fig.height=5}

uniModelFit = function(model, dat){
  
  # settings
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      'log10_popdense'),
                  state_interventions = colnames(data.google)[intv.colums])
  predictors = unlist(predictors)
  
  data.used = dat[rowSums(is.na(dat[ ,c(predictors, 'log_Rt_previous', 'weights', 'state_name')])) == 0, ]
  
  tem = lapply(predictors, function(x){
  
        
        if(model == 'linear'){
          
          fml.log <-  paste('log_Rt ~ ',
                            x,
                            '+ log_Rt_previous + state_name',
                            sep = "")
      
          fml.used <- as.formula(fml.log)
          
          m = lm(fml.used,
                 weights = weights,
                 data = data.used)
          type = 'OLS'
          
          }
        
        if(model == 'gee'){
          
          fml.log <-  paste('log_Rt ~ ',
                            x,
                            '+ state_name',
                            sep = "")
      
          fml.used <- as.formula(fml.log)
          
          m = geeglm(fml.used,
                     data = data.used,
                     id = FIPS,
                     corstr = "ar1",
                     weights = weights)
          type = 'GEE'
          
        }
        
        esti = summary(m)$coefficients
        ci = cbind(esti[,1] - 1.96*esti[ ,2],
                   esti[,1] + 1.96*esti[ ,2])
        esti = cbind(esti, ci)
        
        tem = data.frame(intervention = x,
                         coefficients = esti[x, 1],
                         ci.lower = esti[x, 5],
                         ci.upper = esti[x, 6],
                         Model = type,
                         variables = "Intervention", 
                         stringsAsFactors = FALSE)
        
        if(x %in% c("log10_popsize",
                    "med_income",
                    "percent_poverty")){
          
          tem$variables = 'Census'
                    }
      
        return(tem)
    
  })
  
  tem = do.call('rbind', tem)
  
  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)
  
  return(tem)

}

uniEst = lapply(c('linear', 'gee'), uniModelFit, dat = dat)
uniEst <- do.call('rbind', uniEst)

uniEst$model.type = 'Single intervention'
est$model.type = 'Multiple interventions'

combEst = rbind(est, uniEst)

pUniVsMulGee = ggplot(data = combEst[combEst$Model == 'GEE', ],
                      aes(y = factor(intervention,
                      levels = intv.order),
                      x = coefficients,
                      color = model.type)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = model.type), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5),
                       labels = c('-75', '-50', '-25', '0', '25', '50'),
                       limits = c(0.25, 1.5)) + 
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = 'Model type',
                     values = c('#d9534f', '#f4b693'))

pUniVsMulLogL = ggplot(data = combEst[combEst$Model == 'OLS', ],
                      aes(y = factor(intervention,
                      levels = intv.order),
                      x = coefficients,
                      color = model.type)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = model.type), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'b')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_y_discrete(labels = labels.order) +
  scale_x_continuous(breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5),
                       labels = c('-75', '-50', '-25', '0', '25', '50'),
                       limits = c(0.25, 1.5)) +
  scale_color_manual(name = 'Model type',
                     values = c('#3baee5', '#abdbed'))


# jpeg("output/plot/fig_s10.jpeg",
#      width = 18*600, height = 9*600, res = 600)
pdf("output/plot/fig_s10.pdf",
     width = 18, height = 9)
grid.arrange(pUniVsMulGee,
             pUniVsMulLogL,
             nrow = 1)
dev.off()

```

# Figure S11 - County-specific time and intervention

```{r fig s11, echo=FALSE, fig.width=8, fig.height=5}

est.time <- lapply(c('main', 'timeIntv', 
                     'lmMain', 'lmTimeIntv'),
              function(model){# 1 = gee; 2 = log-lm

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model %in% c('main', 'timeIntv')){type = 'GEE'} else {type = 'OLS'}
  if(model %in% c('main', 'lmMain')){time = 'No'} else {time = 'Yes'}

  esti = summary(models[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   Time = time,
                   variables = c(rep("Census", 3),
                                 rep("Intervention",
                                     length(nm)-3)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.time <- do.call('rbind', est.time)

pCompTimeGee <- ggplot(data = est.time[est.time$Model == 'GEE', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'a')+
  # facet_wrap(~ variables) +
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        # legend.position = c(0.25, 0.35)) +
        legend.position = 'top') +
  # xlim(0.5, 1.2) +
  scale_x_continuous(breaks = c(0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('-40', '-20', '0', '20', '40'),
                     limits = c(0.6, 1.4),
                     expand = c(0, 0)) +
  scale_color_manual(name = "Time",
                     values = c( "#d9534f", "#083765")) +
  scale_y_discrete(labels = labels.order)


pCompTimeLL <- ggplot(data = est.time[est.time$Model == 'OLS', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'b')+
  # facet_wrap(~ variables) +
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        # legend.position = c(0.25, 0.35)) +
        legend.position = 'top') +
  # xlim(0.5, 1.2) +
  scale_x_continuous(breaks = c(0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('-40', '-20', '0', '20', '40'),
                     limits = c(0.6, 1.4),
                     expand = c(0, 0)) + 
  scale_color_manual(name = "Time",
                     values = c( "#3baee5", "#650837")) +
  scale_y_discrete(labels = labels.order)


jpeg('output/plot/fig_s11.jpeg',
     width = 16*600, height = 6*600, res = 600)
# pdf('output/plot/fig_s11.pdf',
#      width = 16, height = 6)
grid.arrange(pCompTimeGee,
             pCompTimeLL,
             nrow = 1)
dev.off()

```

# Figure S12 - County-specific time and intervention - first 10 cases

```{r fig s12, echo=FALSE, fig.width=8, fig.height=5}

n = ncol(case) - 1

case$ten_cases = sapply(1:nrow(case), function(i){
  
  if(case[i, n] < 10){
    return(NA)
  }
  if(case[i, n] >= 10){
    
    return(min(case_dates[case[i, 4:n] >= 10]))
    
  }
  
})
case$ten_cases = as.Date(case$ten_cases,
                        '1970-01-01')

data.new = data.google[ ,!(colnames(data.google) %in% colnames(a)) &
                          !colnames(data.google) %in% c('week_neg2', 'week_neg1')]
data.new = left_join(data.new, 
                     case[ ,c("FIPS",
                                 "ten_cases")])
data.new$week_raw = as.numeric(ceiling((as.Date(data.new$Date) -data.new$ten_cases + 1)/7))
data.new$week = data.new$week_raw
data.new = data.new[!is.na(data.new$week_raw), ]
data.new$week[data.new$week_raw < -4] = -4
data.new$week[data.new$week_raw > 12] = 12


a = dummy(data.new$week, sep = '_')
colnames(a) = paste('week', -4:12, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))

data.new = cbind(data.new, a)
data.new = data.new[ ,!(colnames(data.new) %in% c("date_all_school_closed",
                                                  "date_partial_school_closed"))]
data.new = data.new[rowSums(is.na(data.new)) == 0, ] 

models_country_time = lapply(c("main",
                               "timeIntv",
                  
                               "lmMain",
                               "lmTimeIntv"),
                             modelFit,
                             dat = data.new,
                             stateLevel = FALSE)

names(models_country_time) = c("main",
                  "timeIntv",
                  
                  "lmMain",
                  "lmTimeIntv")


est.county_10 <- lapply(c('main', 'timeIntv', 
                     'lmMain', 'lmTimeIntv'),
                     function(model){# 1 = gee; 2 = log-lm

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model %in% c('main', 'timeIntv')){type = 'GEE'} else {type = 'OLS'}
  if(model %in% c('main', 'lmMain')){time = 'No'} else {time = 'Yes'}

  esti = summary(models_country_time[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   Time = time,
                   variables = c(rep("Census", 3),
                                 rep("Intervention",
                                     length(nm)-3)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.county_10 <- do.call('rbind', est.county_10)

pCompCase10Gee <- ggplot(data = est.county_10[est.county_10$Model == 'GEE', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        # legend.position = c(0.25, 0.35)) +
        legend.position = 'top') +
  # xlim(0.5, 1.2) +
  scale_x_continuous(breaks = c(0.5, 0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('', '-40', '-20', '0', '20', '40'),
                     limits = c(0.5, 1.4),
                     expand = c(0, 0)) +
  scale_color_manual(name = "Time",
                     values = c( "#d9534f", "#083765")) +
  scale_y_discrete(labels = labels.order)


pCompCase10LL <- ggplot(data = est.county_10[est.county_10$Model == 'OLS', ],
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Time,
                    shape = Time)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Time), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = 'b')+
  # facet_wrap(~ variables) +
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        # legend.position = c(0.25, 0.35)) +
        legend.position = 'top') +
  # xlim(0.5, 1.2) +
  scale_x_continuous(breaks = c(0.5, 0.6, 0.8, 1, 1.2, 1.4),
                     labels = c('', '-40', '-20', '0', '20', '40'),
                     limits = c(0.5, 1.4),
                     expand = c(0, 0)) + 
  scale_color_manual(name = "Time",
                     values = c( "#3baee5", "#650837")) +
  scale_y_discrete(labels = labels.order)


jpeg('output/plot/fig_s12.jpeg',
     width = 16*600, height = 6*600, res = 600)
# pdf('output/plot/fig_s12.pdf',
#      width = 16, height = 6)
grid.arrange(pCompCase10Gee,
             pCompCase10LL,
             nrow = 1)
dev.off()

```

# Figure S13 - Permutation of county NPIs

## Panel A-B: Randomize intervention suites between counties (spatially)

### generate randomized data
```{r Randomize interventions, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

getRandomizedData = function(data.used){
  
  randomized.intervention = data.frame(county.original = unique(data.used$FIPS),
                                       stringsAsFactors = FALSE)

  randomized.intervention$random = sample(randomized.intervention$county.original, 
                                          replace = FALSE)

  intv = lapply(1:nrow(randomized.intervention), function(i) {
    
    used = data.used[data.used$FIPS == randomized.intervention$random[i], ]
    used = used[order(used$Date), ]

    df = used[ ,c('FIPS', 'Date', interventions)]
    df$FIPS = randomized.intervention$county.original[i]
    
    df
    
    })
  
  intv = do.call('rbind', intv)
  
  data.random = data.used[ ,!(colnames(data.used) %in% interventions)]
  
  data.random = left_join(data.random, intv)
  
  for(i in interventions){
    
    data.random[is.na(data.random[ ,i]), i] = 0
    
    }
  
  data.random
  
}

data.randomized = lapply(1:100, function(x) data.random = getRandomizedData(data.google))

xs = levels(melt_mat$var)

```

### refit with loglinear model and plot
```{r Randomize interventions loglinear, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

m.random = lapply(data.randomized, function(d){

  # data.random = getRandomizedData(data.google)

  xs = c("log_Rt_previous",
         "log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',

         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  lm(fml, weights = weights, data = d)


})
# saveRDS(m.random,
#         "../data/random_interventions_county.rds")

# m.random = readRDS("../data/random_interventions_county.rds")


esti = lapply(m.random, function(m){
    
    10^(coef(m)[xs])
  
})
esti = do.call('cbind', esti)
esti = melt(esti)
main.esti = data.frame(var = factor(xs,
                                    levels = intv.order),
                       est = 10^(coef(models$lmMain)[xs]),
                       ci.lower = 10^(confint(models$lmMain)[xs, 1]),
                       ci.upper = 10^(confint(models$lmMain)[xs, 2]),
                       stringsAsFactors = FALSE)
esti$Var1 = factor(esti$Var1, levels = intv.order)


permLogL = ggplot(data = main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = esti,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               outlier.size = 0) +
  geom_point(data = main.esti,
             aes(x = est,
                 y = var,
                 color = "Log-linear"),
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "Log-linear"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'b') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("Log-linear" = "#3baee5",
                                "Permutations" = "black"),
                     labels = c('OLS',
                                'Permutations between counties'))

```

### refit with gee model and plot
```{r Randomize interventions gee, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

gee.random = lapply(data.randomized, function(d){

  d = d[rowSums(is.na(d))==0 ,]
  d$Date = as.Date(d$Date)

  xs = c("log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',
         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  geeglm(fml,
         id = FIPS,
         corstr = "ar1",
         weights = weights,
         data = d)


})
# saveRDS(gee.random,
#         "../data/random_interventions_county_gee.rds")


# gee.random = readRDS("../data/random_interventions_county_gee.rds")

gee.esti = lapply(gee.random, function(m){
    10^(coef(m)[xs])
  
})
gee.esti = do.call('cbind', gee.esti)
gee.esti = melt(gee.esti)

coeff = summary(models$main)$coefficients[xs, ]
ci = cbind(coeff[,1] - 1.96*coeff[,2],
           coeff[,1] + 1.96*coeff[,2])

gee.main.esti = data.frame(var = factor(xs,
                                        levels = intv.order),
                       est = 10^(coef(models$main)[xs]),
                       ci.lower = 10^(ci[, 1]),
                       ci.upper = 10^(ci[, 2]),
                       stringsAsFactors = FALSE)

permGEE = ggplot(data = gee.main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = gee.esti,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               outlier.size = 0) +
  geom_point(data = gee.main.esti,
             aes(x = est,
                 y = var,
                 color = "GEE"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "GEE"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'a') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  # xlim(0.4, 1.1) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("GEE" = "#d9534f",
                                "Permutations" = "black"),
                     labels = c('GEE',
                                'Permutations between counties'))


```

## Panel C-D: Randomize interventions week within county (temporally)

### generate randomized data
```{r Randomize interventions within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

getRandomizedDataWithinCounty = function(data.used){
  
  county.list = unique(data.used$FIPS)
  
  county.week = lapply(county.list, function(i) {
    
    data.used$Date[data.used$FIPS == i]
    
  })
  
  county.intv = lapply(county.list, function(i) {
    
    data.used[data.used$FIPS == i, interventions]
    
  })
  
  county.length = lapply(county.week, function(i) {
    
    length(i)
    
  })
  
  df = data.used[ ,!(colnames(data.used) %in% interventions)]
  
  randomized.df = lapply(1:100, function(x) {
    
    randomized.df = lapply(1:length(county.list), function(i){
      
      rt.df = data.frame(FIPS = county.list[[i]],
                         Date = county.week[[i]],
                         stringsAsFactors = FALSE)
      
      randomized.weeks = sample(1:county.length[[i]], replace = FALSE)
      
      rd.intv = county.intv[[i]][randomized.weeks, ]
      
      rt.df = cbind(rt.df, rd.intv)
      
    })
    
    randomized.df = do.call('rbind', randomized.df)
    
    randomized.df = left_join(df, randomized.df)
    
    
    
  })
  
  randomized.df
  
}

data.randomized.within = getRandomizedDataWithinCounty(data.google)


```

### refit with loglinear model and plot
```{r Randomize interventions loglinear within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

m.random.within.county = lapply(data.randomized.within, function(d){

  xs = c("log_Rt_previous",
         "log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',

         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  lm(fml, weights = weights, data = d)


})
# saveRDS(m.random.within.county,
#         "../data/random_interventions_within_county.rds")

# m.random.within.county = readRDS("../data/random_interventions_within_county.rds")


esti.within = lapply(m.random.within.county, function(m){
    
    10^(coef(m)[xs])
  
})
esti.within = do.call('cbind', esti.within)
esti.within = melt(esti.within)

esti.within$Var1 = factor(esti.within$Var1, levels = intv.order)


permLogLWithinCounty = ggplot(data = main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = esti.within,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               # color = grey(0.6),
               outlier.size = 0) +
  geom_point(data = main.esti,
             aes(x = est,
                 y = var,
                 color = "Log-linear"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "Log-linear"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'd') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("Log-linear" = "#3baee5",
                                "Permutations" = grey(0.3)),
                     labels = c('OLS',
                                'Permutations within county'))

```

### refit with gee model and plot
```{r Randomize interventions gee within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

gee.random.within = lapply(data.randomized.within, function(d){

  # data.random = getRandomizedData(data.google)

  d = d[rowSums(is.na(d))==0 ,]
  d$Date = as.Date(d$Date)

  xs = c("log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',
         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  geeglm(fml,
         id = FIPS,
         corstr = "ar1",
         weights = weights,
         data = d)


})
# saveRDS(gee.random,
#         "../data/random_interventions_county_gee.rds")


# gee.random = readRDS("../data/random_interventions_county_gee.rds")

gee.esti.within = lapply(gee.random.within, function(m){
    10^(coef(m)[xs])
  
})
gee.esti.within = do.call('cbind', gee.esti.within)
gee.esti.within = melt(gee.esti.within)

permGEEWithin = ggplot(data = gee.main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = gee.esti.within,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               outlier.size = 0) +
  geom_point(data = gee.main.esti,
             aes(x = est,
                 y = var,
                 color = "GEE"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "GEE"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'c') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  # xlim(0.4, 1.1) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("GEE" = "#d9534f",
                                "Permutations" = grey(0.3)),
                     labels = c('GEE',
                                'Permutations within counties'))


```

## Figure S13 - output plot
```{r Randomize intervention plot, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

jpeg('output/plot/fig_s13.jpeg',
     width = 16*600, height = 12*600, res = 600)
pdf('output/plot/fig_s13.pdf',
     width = 16, height = 12)

grid.arrange(permGEE, permLogL,
             permGEEWithin, permLogLWithinCounty,
             nrow = 2, ncol = 2)

dev.off()

```

# Figure S14 - Permutation of school closure only 

## Panel A-B: Randomize school only between counties (spatially)
### generate randomized data
```{r Randomize interventions school only, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

getRandomizedDataSC = function(data.used){
  
  randomized.intervention = data.frame(county.original = unique(data.used$FIPS),
                                       stringsAsFactors = FALSE)

  randomized.intervention$random = sample(randomized.intervention$county.original, 
                                          replace = FALSE)

  intv = lapply(1:nrow(randomized.intervention), function(i) {
    
    used = data.used[data.used$FIPS == randomized.intervention$random[i], ]
    used = used[order(used$Date), ]

    df = used[ ,c('FIPS', 'Date', 'earliest_date_school_closed')]
    df$FIPS = randomized.intervention$county.original[i]
    
    df
    
    })
  
  intv = do.call('rbind', intv)
  
  data.random = data.used[ ,colnames(data.used) !='earliest_date_school_closed']
  
  data.random = left_join(data.random, intv)
  
  for(i in interventions){
    
    data.random[is.na(data.random[ ,i]), i] = 0
    
    }
  
  data.random
  
}

data.randomized.sc = lapply(1:100, function(x) data.random = getRandomizedDataSC(data.google))

xs = levels(melt_mat$var)


```

### refit with loglinear model and plot
```{r Randomize interventions loglinear school only, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

m.random.sc = lapply(data.randomized.sc, function(d){

  # data.random = getRandomizedData(data.google)

  xs = c("log_Rt_previous",
         "log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',

         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  lm(fml, weights = weights, data = d)


})
# saveRDS(m.random,
#         "../data/random_interventions_county.rds")

# m.random = readRDS("../data/random_interventions_county.rds")


esti.sc = lapply(m.random.sc, function(m){
    
    10^(coef(m)[xs])
  
})
esti.sc = do.call('cbind', esti.sc)
esti.sc = melt(esti.sc)
main.esti = data.frame(var = factor(xs,
                                    levels = intv.order),
                       est = 10^(coef(models$lmMain)[xs]),
                       ci.lower = 10^(confint(models$lmMain)[xs, 1]),
                       ci.upper = 10^(confint(models$lmMain)[xs, 2]),
                       stringsAsFactors = FALSE)
esti.sc$Var1 = factor(esti.sc$Var1, levels = intv.order)


permLogLSc = ggplot(data = main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = esti.sc,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               # color = grey(0.6),
               outlier.size = 0) +
  geom_point(data = main.esti,
             aes(x = est,
                 y = var,
                 color = "Log-linear"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "Log-linear"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'b') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  # xlim(0.4, 1.1) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("Log-linear" = "#3baee5",
                                "Permutations" = "black"),
                     labels = c('OLS',
                                'Permutations between counties'))

```

### refit with gee model and plot
```{r Randomize interventions gee school only, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

gee.random.sc = lapply(data.randomized.sc, function(d){

  # data.random = getRandomizedData(data.google)

  d = d[rowSums(is.na(d))==0 ,]
  d$Date = as.Date(d$Date)

  xs = c("log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',
         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  geeglm(fml,
         id = FIPS,
         corstr = "ar1",
         weights = weights,
         data = d)


})
# saveRDS(gee.random,
#         "../data/random_interventions_county_gee.rds")


# gee.random = readRDS("../data/random_interventions_county_gee.rds")

gee.esti.sc = lapply(gee.random.sc, function(m){
    10^(coef(m)[xs])
  
})
gee.esti.sc = do.call('cbind', gee.esti.sc)
gee.esti.sc = melt(gee.esti.sc)

coeff = summary(models$main)$coefficients[xs, ]
ci = cbind(coeff[,1] - 1.96*coeff[,2],
           coeff[,1] + 1.96*coeff[,2])

gee.main.esti = data.frame(var = factor(xs,
                                        levels = intv.order),
                       est = 10^(coef(models$main)[xs]),
                       ci.lower = 10^(ci[, 1]),
                       ci.upper = 10^(ci[, 2]),
                       stringsAsFactors = FALSE)

permGEESc = ggplot(data = gee.main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = gee.esti.sc,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               outlier.size = 0) +
  geom_point(data = gee.main.esti,
             aes(x = est,
                 y = var,
                 color = "GEE"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "GEE"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'a') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  # xlim(0.4, 1.1) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("GEE" = "#d9534f",
                                "Permutations" = "black"),
                     labels = c('GEE',
                                'Permutations between counties'))


```


## Randomize interventions week within county
## Panel C-D: Randomize the weeks when school was closed within counties (temporally)
```{r Randomize interventions within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

getRandomizedDataWithinCountySc = function(data.used){
  
  county.list = unique(data.used$FIPS)
  
  county.week = lapply(county.list, function(i) {
    
    data.used$Date[data.used$FIPS == i]
    
  })
  
  county.intv = lapply(county.list, function(i) {
    
    data.used[data.used$FIPS == i, 'earliest_date_school_closed']
    
  })
  
  county.length = lapply(county.week, function(i) {
    
    length(i)
    
  })
  
  df = data.used[ ,colnames(data.used) != 'earliest_date_school_closed']
  
  randomized.df = lapply(1:100, function(x) {
    
    randomized.df = lapply(1:length(county.list), function(i){
      
      rt.df = data.frame(FIPS = county.list[[i]],
                         Date = county.week[[i]],
                         stringsAsFactors = FALSE)
      
      randomized.weeks = sample(1:county.length[[i]], replace = FALSE)
      
      rd.intv = county.intv[[i]][randomized.weeks]
      
      rt.df = cbind(rt.df, rd.intv)
      
    })
    
    randomized.df = do.call('rbind', randomized.df)
    
    colnames(randomized.df)[3] = 'earliest_date_school_closed'
    
    randomized.df = left_join(df, randomized.df)
    
    
  })
  
  randomized.df
  
}

data.randomized.within.sc = getRandomizedDataWithinCountySc(data.google)


```

### refit with loglinear model and plot
```{r Randomize interventions loglinear within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

m.random.within.county.sc = lapply(data.randomized.within.sc, function(d){

  xs = c("log_Rt_previous",
         "log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',

         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  lm(fml, weights = weights, data = d)


})
# saveRDS(m.random.within.county,
#         "../data/random_interventions_within_county.rds")

# m.random.within.county = readRDS("../data/random_interventions_within_county.rds")


esti.within.sc = lapply(m.random.within.county.sc, function(m){
    
    10^(coef(m)[xs])
  
})
esti.within.sc = do.call('cbind', esti.within.sc)
esti.within.sc = melt(esti.within.sc)

esti.within.sc$Var1 = factor(esti.within.sc$Var1, levels = intv.order)


permLogLWithinCountySc = ggplot(data = main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = esti.within.sc,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               # color = grey(0.6),
               outlier.size = 0) +
  geom_point(data = main.esti,
             aes(x = est,
                 y = var,
                 color = "Log-linear"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "Log-linear"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'd') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("Log-linear" = "#3baee5",
                                "Permutations" = grey(0.3)),
                     labels = c('OLS',
                                'Permutations within county'))

```

### refit with gee model and plot
```{r Randomize interventions gee within county, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

gee.random.within.sc = lapply(data.randomized.within.sc, function(d){

  # data.random = getRandomizedData(data.google)

  d = d[rowSums(is.na(d))==0 ,]
  d$Date = as.Date(d$Date)

  xs = c("log10_popsize",
         "med_income",
         "percent_poverty",
         'log10_popdense',
         'med_age',
         'prop_white',
         'prop_belowCollege',
         "earliest_date_school_closed",
         "daycare_close",
         "face_mask",
         "lifestyle_close",
         "lv3_stay_home",
         "ban_nursing_home_visit",
         "suspend_medical",
         "state_name")

  fml = as.formula(paste('log_Rt ~',
                         paste(xs,
                               collapse = '+'),
                         sep = ''))

  geeglm(fml,
         id = FIPS,
         corstr = "ar1",
         weights = weights,
         data = d)


})
# saveRDS(gee.random,
#         "../data/random_interventions_county_gee.rds")


# gee.random = readRDS("../data/random_interventions_county_gee.rds")

gee.random.within.sc = lapply(gee.random.within.sc, function(m){
    10^(coef(m)[xs])
  
})
gee.random.within.sc = do.call('cbind', gee.random.within.sc)
gee.random.within.sc = melt(gee.random.within.sc)


permGEEWithinSc = ggplot(data = gee.main.esti,
               aes(x = est,
                   y = var)) +
  geom_boxplot(data = gee.random.within.sc,
               aes(x = value,
                   y = Var1,
                   color = "Permutations"),
               width = 0.3,
               outlier.size = 0) +
  geom_point(data = gee.main.esti,
             aes(x = est,
                 y = var,
                 color = "GEE"),
             # color = '#B22234',
             alpha = 0.8,
                size = 1.3) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = "GEE"), 
                width=0.3,
                # color = '#B22234',
                alpha = 0.6,
                size = 1) +
  geom_vline(xintercept = 1,
             linetype = 'dashed') + 
  theme_classic() +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'c') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     limits = c(0.4, 1.4),
                     labels = c('-60', '-40', '-20',
                                '0', '20', '40'),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = "",
                     values = c("GEE" = "#d9534f",
                                "Permutations" = grey(0.3)),
                     labels = c('GEE',
                                'Permutations within counties'))


```

## Figure S14 - output plot
```{r Randomize intervention plot, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

jpeg('output/plot/fig_s14.jpeg',
     width = 16*600, height = 12*600, res = 600)

pdf('output/plot/fig_s14.pdf',
    width = 16, height = 12 )

grid.arrange(permGEESc, permLogLSc,
             permGEEWithinSc, permLogLWithinCountySc,
             nrow = 2, ncol = 2)

dev.off()

```

# Figure S15 - Distribution of workplace attendance

```{r fig s15, include=FALSE}

xLabs = unique(data.google$Date)
xLabs = xLabs[order(xLabs)]
xLabs = format(xLabs, '%m/%d')

wp = ggplot(data = data.google,
       aes(x = factor(Date),
           y = percentChange_mobility_work)) +
  geom_boxplot(outlier.color = NA,
               na.rm = TRUE,
               width = 0.3,
               outlier.size = 0) +
  geom_hline(yintercept = 0,
             color = 'red',
             linetype = 'dashed') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 0.5,
                                   vjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'top') +
  scale_x_discrete(name = 'Week',
                   labels = xLabs) +
  scale_y_continuous(name = 'Change in workplace presence, %',
                     breaks = seq(-80, 20, 20),
                     limits = c(-80, 20),
                     expand = c(0, 0))

# jpeg("output/plot/fig_s15.jpeg",
#      width = 9*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s15.pdf",
     width = 9, height = 7.5)
wp
dev.off()


```

# Figure S16 - Mediation analysis of workplace attendance

```{r mediation analysis, include=FALSE}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset


fitMediation = function(dat, var){
  
  fml.Y = paste('log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + ', 
                var,
                sep = '')
  
  fml.M = paste('percentChange_mobility_work ~ ', 
                var,
                sep = '')
  
  model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
  model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
  results <- mediate(model.M,
                     model.Y,
                     treat = var,
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 10)

  return(results)
  
  # list(model.M, model.Y)
  
}

mediationModels = list(NA, NA, NA, NA, NA, NA, NA)

#
# 1 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + daycare_close'

fml.M = 'percentChange_mobility_work ~ daycare_close'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[1]] = mediate(model.M,
                     model.Y,
                     treat = 'daycare_close',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100)

#
# 2 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + face_mask'

fml.M = 'percentChange_mobility_work ~ face_mask'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[2]] = mediate(model.M,
                     model.Y,
                     treat = 'face_mask',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 

#
# 3 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + lifestyle_close'

fml.M = 'percentChange_mobility_work ~ lifestyle_close'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[3]] = mediate(model.M,
                     model.Y,
                     treat = 'lifestyle_close',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 

#
# 4 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + lv3_stay_home'

fml.M = 'percentChange_mobility_work ~ lv3_stay_home'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[4]] = mediate(model.M,
                     model.Y,
                     treat = 'lv3_stay_home',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 


#
# 5 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + ban_nursing_home_visit'

fml.M = 'percentChange_mobility_work ~ ban_nursing_home_visit'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[5]] = mediate(model.M,
                     model.Y,
                     treat = 'ban_nursing_home_visit',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 


#
# 6 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + suspend_medical'

fml.M = 'percentChange_mobility_work ~ suspend_medical'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[6]] = mediate(model.M,
                     model.Y,
                     treat = 'suspend_medical',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 

#
# 7 ---
#

fml.Y = 'log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + earliest_date_school_closed'

fml.M = 'percentChange_mobility_work ~ earliest_date_school_closed'

model.Y = lm(as.formula(fml.Y), data = dat, weights = weights)
model.M = lm(as.formula(fml.M), data = dat, weights = weights)
  
mediationModels[[7]] = mediate(model.M,
                     model.Y,
                     treat = 'earliest_date_school_closed',
                     mediator = 'percentChange_mobility_work',
                     boot = TRUE,
                     sims = 100) 



saveRDS(mediationModels, 'data/mediation_models.rds')

```

```{r fig s16, include=TRUE}

plotMedEff = function(mediationModels, panel){
  
  m.used = mediationModels[[panel]]
  
  df = data.frame(rbind(m.used$d.avg.ci,
                        m.used$z.avg.ci,
                        m.used$d.avg.ci + m.used$z.avg.ci))
  colnames(df) = c('ci.lower', 'ci.upper')
  
  df$est = c(m.used$d.avg,
             m.used$z.avg,
             m.used$d.avg + m.used$z.avg)
  
  for(i in 1:3){
    
    df[,i] = 10^df[,i]
  }
  
  p = c(m.used$n.avg, m.used$n.avg.ci)
  
  p = paste('Prop. mediated ',
            sprintf('%.02f', p[1]),
            ' (',
            sprintf('%.02f', p[2]),
            ', ',
            sprintf('%.02f', p[3]),
            ')',
            sep = '')
  
  txt = labels.order[names(labels.order) == interventions[panel]]
  
  ys = factor(3:1)
  
  ggplot(data = df) +
    geom_point(aes(x = est,
                   y = ys)) +
    geom_errorbar(aes(xmin=ci.lower,
                      xmax=ci.upper, 
                      y = ys,
                      width=0.05)) +
    geom_vline(xintercept = 1,
               lty = 3) +
    geom_text(aes(x = 0.4,
                  y = 3.3,
                  label = p),
              color = 'blue',
              vjust = "inward", 
              hjust = "inward") +
    scale_y_discrete(name = '',
                     labels = c('Total', 'ADE', 'ACME')) +
    scale_x_continuous(name = '',
                       breaks = seq(0.3, 1.3, 0.1),
                       labels = c('', '60%', '', '40%', '', '20', '', '0', '', '20', ''),
                       limits = c(0.3, 1.3)) +
    labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
         y = "",
         title = txt)+
    # facet_wrap(~ variables) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 0, 
                                     hjust = 0.5, 
                                     size = 14,
                                     color = 'black'),
          axis.text.y = element_text(size = 14,
                                     color = 'black'),
          strip.text.x = element_text(size = 14, face = "bold"),
          strip.background = element_blank(),
          axis.title.x = element_text(size = 14, face = 'bold'),
          axis.title.y = element_text(size = 14, face = 'bold'),
          plot.title = element_text(size = 20, face = 'bold'),
          plot.title.position = "panel",
          plot.margin = unit(c(2,1,1,1), "cm"),
          # legend.position = c(0.25, 0.35)) +
          legend.position = 'top') 
  
}

medEffPlots = lapply(1:length(mediationModels), function(i) {
  plotMedEff(mediationModels = mediationModels,
             panel = i)
})

# jpeg('output/plot/fig_s16.jpeg',
#      height = 12*480, width = 15*480, res = 480)
pdf('output/plot/fig_s16.pdf',
     height = 12, width = 15)
ggarrange(medEffPlots[[1]],
          medEffPlots[[2]],
          medEffPlots[[3]],
          medEffPlots[[4]],
          medEffPlots[[5]],
          medEffPlots[[6]],
          medEffPlots[[7]],
          nrow = 3,
          ncol = 3,
          align = 'hv')
dev.off()

```

# Figure S17 - Quasi mediation analysis for GEE

```{r fig s17, include=FALSE}

dat = data.google
# dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset


fitMediation = function(dat, var){
  
  fml.uni = paste('log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + ', 
                var,
                sep = '')
  
  fml.Y = paste('log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work + ', 
                var,
                sep = '')
  
  fml.full = paste('log_Rt ~ log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + state_name + percentChange_mobility_work +', 
                paste(interventions, collapse = ' + '),
                sep = '')
  
  fs = list(fml.uni, fml.Y, fml.full)
  
  ms = lapply(1:3, function(x){
    
     m = geeglm(as.formula(fs[[x]]), 
                id = FIPS,
                weights = weights, 
                corstr = 'ar1',
                data = dat)
     
     coeff = summary(m)$coefficients[var, ]
     
     ci = cbind(coeff[1] - 1.96*coeff[2],
                coeff[1] + 1.96*coeff[2])
     
     tab = data.frame(interventions = var,
                       coefficients = 10^(coeff[1]),
                       ci.lower = 10^(ci[1]),
                       ci.upper = 10^(ci[2]),
                       Model = c('Single NPI', 
                                 'Single NPI mediate', 
                                 'Multiple NPI mediate')[x],
                       stringsAsFactors = FALSE)
    tab
     
  })
  
  ms = do.call('rbind', ms)

  return(ms)
  
  # list(model.M, model.Y)
  
}

medGEE = lapply(interventions, function(var) {
  
  print(var)
  
  fitMediation(dat = dat, var = var)
  
})

medGEE = do.call('rbind', medGEE)

main.gee = gee.out[gee.out$intervention %in% interventions,
                   ]
colnames(main.gee) = colnames(medGEE)
main.gee$Model = 'Multiple NPI'

medGEE = rbind(medGEE, main.gee)

medGEE$Model = factor(medGEE$Model,
                      levels = rev(c('Single NPI',
                                 'Single NPI mediate',
                                 'Multiple NPI',
                                 'Multiple NPI mediate')))

medGEEPlot = ggplot(data = medGEE,
                      aes(y = factor(interventions,
                      levels = intv.order),
                      x = Estimate,
                      color = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=Estimate.1,
                    xmax=Estimate.2,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = '')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, 
                                    face = "bold"),
        strip.background = element_blank(),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14,
                                    face = 'bold'),
        axis.title.y = element_text(size = 14, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'right') +
  scale_x_continuous(breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5),
                       labels = c('-75', '-50', '-25', '0', '25', '50'),
                       limits = c(0.25, 1.5),
                     expand = c(0, 0)) + 
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = 'Model type',
                     values = c('#ffc2cd', '#ff6289', '#ff084a', '#7f0425'))  + 
  guides(color = guide_legend(reverse = TRUE))


# jpeg("output/plot/fig_s17.jpeg",
#      width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s17.pdf",
     width = 10, height = 7.5)
medGEEPlot
dev.off()


```

# Figure S18 - State-level school closure

## Fit main model and sensitivity analyses state

```{r reg google state, echo=FALSE, fig.width=12, fig.height=6, warning=FALSE, message=FALSE, include=FALSE}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset

country_weeks = dummy(dat$time_since_national_start, sep = '_')
colnames(country_weeks) = paste('country_week', 6:21, sep = '_')

a = dummy(data.google$week, sep = '_')
colnames(a) = paste('week', -2:13, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))

modelsState = lapply(c("main",
                       
                       "lmMain",
                       
                       "lassoMain"
                       ),
                     modelFit,
                     dat = dat,
                     stateLevel = TRUE)

names(modelsState) = c("main",
                  
                       "lmMain",
                  
                       "lassoMain")


```

## Fig. 18b: Linear regression and GEE state
```{r LASSO estimates state, echo = FALSE, fig.width=8, fig.height=6, fig.align='cneter'}

getMeltState = function(model){

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "school_close_state",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")

  # coeficient matrix
  mat = as.matrix(coef(model)[nm, ])
  colnames(mat) <- paste('L', model$lambda, sep = '')
  mat = data.frame(var = rownames(mat),
                 mat,
                 stringsAsFactors = FALSE)
  melt_mat = mat %>% gather(lambda, coef, -var)
  melt_mat$coef[melt_mat$coef == 0] <- NA
  melt_mat$lambda = as.numeric(gsub('L', '', melt_mat$lambda))

  lvls <- data.frame(var = unique(melt_mat$var),
                     stringsAsFactors = FALSE)
  lvls$na = sapply(lvls$var, function(x) sum(is.na(melt_mat$coef[melt_mat$var == x])))
  lvls$cat = 2
  lvls$cat[lvls$var %in% c("log10_popsize",
                           "med_income",
                           "percent_poverty",
                           'log10_popdense',
                           'med_age',
                           'prop_white',
                           'prop_belowCollege')] = 1
  lvls = lvls[order(lvls$cat, -lvls$na), ]

  melt_mat$var = factor(melt_mat$var, 
                        levels = lvls$var)

  melt_mat

}

melt_mat_state = getMeltState(modelsState$lassoMain)
melt_mat_state$coef = 10^(melt_mat_state$coef)

intv.order.state = intv = levels(melt_mat_state$var)
labels.order.state = c('log10_popsize' = 'Log population size',
                 'log10_popdense' = 'Log population density',
                 'med_income' = 'Median income',
                 'percent_poverty' = 'Decile of poverty',
                 'med_age' = 'Median age',
                 'prop_white' = 'Decile of white',
                 'prop_belowCollege' = 'Decile of below college',
  
                 'suspend_medical' = 'Medical service suspension',
                 'face_mask' = 'Face mask',
                 'ban_nursing_home_visit' = 'Nursing home visit ban',
                 'daycare_close' = 'Daycare closure',
                 'lv3_stay_home' = 'Stay at home',
                 'lifestyle_close' = 'Leisure activities closure',
                 'school_close_state' = 'School closure')
labels.order.abb.state = c('log10_popsize' = 'Log population size (Pop)',
                     'log10_popdense' = 'Log population density (PopD)',
                 'med_income' = 'Median income (Inc)',
                 'percent_poverty' = 'Decile of poverty (Pov)',
                 'med_age' = 'Median age (Age)',
                 'prop_white' = 'Decile of white (Race)',
                 'prop_belowCollege' = 'Decile of below college (Edu)',
  
                 'suspend_medical' = 'Medical service suspension (MS)',
                 'face_mask' = 'Face mask (FM)',
                 'ban_nursing_home_visit' = 'Nursing home visit ban (NH)',
                 'daycare_close' = 'Daycare closure (DC)',
                 'lv3_stay_home' = 'Stay at home (SH)',
                 'lifestyle_close' = 'Leisure activities closure (LA)',
                 'school_close_state' = 'School closure (SC)')
labels.abb.state = c('log10_popsize' = 'Pop',
                'log10_popdense' = 'PopD',
                 'med_income' = 'Inc',
                 'percent_poverty' = 'Pov',
                 'med_age' = 'Age',
                 'prop_white' = 'Race',
                 'prop_belowCollege' = 'Edu',
  
                 'suspend_medical' = 'MS',
                 'face_mask' = 'FM',
                 'ban_nursing_home_visit' = 'NH',
                 'daycare_close' = 'DC',
                 'lv3_stay_home' = 'SH',
                 'lifestyle_close' = 'LA',
                 'school_close_state' = 'SC')


fig3BState = ggplot(melt_mat_state,
       aes(x = lambda,
           y = var,
           fill = coef)) +
  geom_tile(color = 'black') +
  scale_fill_gradientn(colours = c('#3C3B6E', "white", "#B22234"),
                       guide = "colorbar",
                       values = rescale(c(0.4, 1, 1.2)),
                       limits=c(0.4, 1.2),
                       name="Relative changes in Rt, %",
                       space = "Lab",
                       na.value = grey(0.9),
                       breaks = c(0.40, 0.70, 1, 1.2),
                       labels = c('-60', '-30', '0', '20')) +
  theme_bw() +
  labs(y = '',
       x = 'Lambda (penalty)',
       title = 'b') +
  theme(axis.text.x = element_text(size = 16,
                                   color = 'black'),
        # axis.text.y = element_text(size = 14,
        #                            color = 'black'),
        axis.title.x = element_text(size = 16,
                                    face = 'bold'),
        axis.title.y = element_text(size = 16,
                                    face = 'bold'),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top') 

fig3BState

```

## Fig. 18a: Linear regression and GEE state

```{r lm and gee plot state, echo=FALSE, fig.width=8, fig.height=5}

estState <- lapply(c('main', 'lmMain'),
              function(model){# 1 = gee; 2 = log-lm

 nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "school_close_state",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model == 'main'){type = 'GEE'} else {type = 'OLS'}

  esti = summary(modelsState[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   variables = c(rep("Census", 7),
                                 rep("Intervention",
                                     length(nm)-7)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

estState <- do.call('rbind', estState)

fig3AState <- ggplot(data = estState,
                aes(y = factor(intervention,
                               levels = intv.order.state),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16,
                                   color = 'black'),
        legend.title = element_text(size = 16,
                                   color = 'black')) +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = labels.order.abb.state) +
  scale_x_continuous(breaks = seq(0.5, 1.3, 0.1),
                     labels = c('-50', '-40', '-30', 
                                '-20', '-10', '0', '10', '20', '30'),
                     limits = c(0.5, 1.3),
                     expand = c(0, 0))

fig3AState


```

## Fig. 18c: Drop one intervention

```{r drop intervention analyis state, echo=FALSE, fig.width=10, fig.height=6.5}

dropInterventionModelFitState = function(dat, models){
  
  intv.colums = c(26:32)
  
  # settings
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      'log10_popdense'),
                  state_interventions = colnames(data.google)[intv.colums])
  predictors = unlist(predictors)
  
  data.used = dat[rowSums(is.na(dat[ ,c(predictors, 'log_Rt_previous', 'weights', 'state_name')])) == 0, ]
  
  tem = lapply(predictors, function(x){
  
    x.used = predictors[!(predictors %in% x)]
    
    fml.log <-  paste('log_Rt ~ ',
                      paste(x.used,
                            collapse = " + "),
                      '+ log_Rt_previous + state_name',
                      sep = "")
      
    fml.used <- as.formula(fml.log)
    
    m = lm(fml.used,
           weights = weights,
           data = data.used)
    
    tem = data.frame(intervention = predictors,
                     dropped.variable = x, 
                     coef.main = coef(models$lmMain)[predictors],
                     coef.drop = coef(m)[predictors],
                     stringsAsFactors = FALSE)

    tem$coef.diff = tem$coef.main - tem$coef.drop
      
    return(tem)
    
  })
  
  tem = do.call('rbind', tem)
  
  tem$risk.chage = 10^(tem$coef.diff)
  
  return(tem)

}

estDropInterventionState = dropInterventionModelFitState(dat, modelsState)
estDropInterventionState$intervention = factor(estDropInterventionState$intervention,
                                          levels = levels(melt_mat$var))
estDropInterventionState$dropped.variable = factor(estDropInterventionState$dropped.variable,
                                              levels = levels(melt_mat$var))

fig3CState <- ggplot(data = estDropInterventionState, 
                aes(x = dropped.variable, 
                    y = intervention, 
                    fill = risk.chage)) +
  geom_tile(color = "black", size = 0.2) +
  scale_fill_gradient2(low = "#0392cf", high = "#ee4035", mid = "white",
                       midpoint = 1, 
                       limit = c(0.85, 1.25), 
                       space = "Lab",
                       name="Original to the dropped\n model",
                       labels = c('0.85', '', '', '', '1.25')) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   size = 16, 
                                   hjust = 1,
                                   color = 'black'),
       axis.text.y = element_text(size = 14,
                                   color = 'black'),
       # axis.text.y = element_blank(),
       axis.title.x = element_text(size = 16,
                                    face = 'bold'),
       axis.title.y = element_text(size = 16, 
                                    face = 'bold'),
        plot.title = element_text(size = 20, 
                                  face = 'bold'),
       # plot.margin = unit(c(0.5,0.5,0.5,0), "cm"),
       plot.title.position = "plot",
       legend.text = element_text(size = 16),
       legend.title = element_text(size = 16),
       legend.position = 'top') +
 coord_fixed() +
   labs(title = "c",
       x = "Dropped intervention",
       y = "") +
  scale_y_discrete(labels = labels.abb.state) +
  scale_x_discrete(labels = labels.abb.state)

fig3CState

```

## figure s18 output
```{r fig s18  state, echo=FALSE, fig.width=12, fig.height=18, warning=FALSE, message=FALSE, fig.align='center'}

jpeg('output/plot/fig_s18.jpeg', width = 20*600, height = 8.3*600, res = 600)
# pdf('output/plot/fig_s18.pdf', width = 20, height = 8.3)

ggarrange(fig3AState,
          fig3BState,
          fig3CState,
          heights = 6,
          widths = c(10, 4, 8),
          nrow = 1,
          align = "h")

dev.off()


```

# Figure S19 - Subset of 2 weeks since county's first case
```{r fig s19, echo=FALSE, fig.width=10, fig.height=6.5}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ]

dat.list = list(full = dat,
                subset = dat[dat$week_raw > 2, ])

models.comp.gee = lapply(dat.list, modelFit, model = 'main', stateLevel = FALSE)

est.comp.gee <- lapply(1:2,
                   function(model){# 1 = duration; 2 = categorical

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         'prop_white',
         'prop_belowCollege',
         'log10_popdense',
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")

  esti = summary(models.comp.gee[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   dataset = c("Full",
                             "Subset")[model])


  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.comp.gee <- do.call('rbind', est.comp.gee)

pTwoWeeksGEE <- ggplot(data = est.comp.gee,
       aes(y = factor(intervention,
                      levels = intv.order),
           x = coefficients,
           color = dataset)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = dataset), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       # y = "Census and intervention",
       y = '',
       title = 'a')+
    theme_classic() +
  theme(axis.text.x = element_text(size = 16,
                                     color = 'black'),
          axis.title.x = element_text(size = 16,
                                      face = 'bold'),
          axis.title.y = element_text(size = 16,
                                      face = 'bold'),
          axis.text.y = element_text(size = 16,
                                     color = 'black'),
          legend.title = element_text(size = 16),
          legend.text = element_text(size = 16),
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(size = 20, face = 'bold'),
          plot.title.position = "plot",
          legend.position = 'top',
        plot.margin = unit(c(1,1,1,1), 'cm')) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     labels = c('-60', '-40', '-20', '0', '20', '40'),
                     limits = c(0.4, 1.4),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = 'Data set',
                     values = c('#d9534f', '#eca9a7'))

# log-linear 
models.comp = lapply(dat.list, modelFit, model = 'lmMain', stateLevel = FALSE)

est.comp <- lapply(1:2,
                   function(model){# 1 = duration; 2 = categorical

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         'prop_white',
         'prop_belowCollege',
         'log10_popdense',
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")

  esti = summary(models.comp[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   dataset = c("Full",
                             "Subset")[model])


  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.comp <- do.call('rbind', est.comp)

pTwoWeeksLogLm <- ggplot(data = est.comp,
       aes(y = factor(intervention,
                      levels = intv.order),
           x = coefficients,
           color = dataset)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = dataset), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       # y = "Census and intervention",
       y = "",
       title = 'b')+
    theme_classic() +
  theme(axis.text.x = element_text(size = 16,
                                     color = 'black'),
          axis.title.x = element_text(size = 16,
                                      face = 'bold'),
          axis.title.y = element_text(size = 16,
                                      face = 'bold'),
          axis.text.y = element_text(size = 16,
                                     color = 'black'),
          legend.title = element_text(size = 16),
          legend.text = element_text(size = 16),
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(size = 20, face = 'bold'),
          plot.title.position = "plot",
          legend.position = 'top',
        plot.margin = unit(c(1,1,1,1), 'cm')) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                     labels = c('-60', '-40', '-20', '0', '20', '40'),
                     limits = c(0.4, 1.4),
                     expand = c(0, 0)) +
  scale_y_discrete(labels = labels.order) +
  scale_color_manual(name = 'Data set',
                     values = c('#3BAEE5', '#9dd6f2'))

# jpeg('output/plot/fig_s19.jpeg',
#      width = 16*600, height = 6*600, res = 600)
pdf('output/plot/fig_s19.pdf',
     width = 16, height = 6)

grid.arrange(pTwoWeeksGEE, pTwoWeeksLogLm, nrow = 1)

dev.off()

```

# Figure S20 - Spatial correlation

```{r fig s20, echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE, include=FALSE}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset

country_weeks = dummy(dat$time_since_national_start, sep = '_')
colnames(country_weeks) = paste('country_week', 6:21, sep = '_')

a = dummy(data.google$week, sep = '_')
colnames(a) = paste('week', -2:13, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))
  
modelFitSP = function(model, dat, stateLevel){
  
  print(model)
  
  if(stateLevel){
    
    state_interventions = c("daycare_close",
                            "face_mask",
                            "lifestyle_close",
                            "lv3_stay_home",
                            "ban_nursing_home_visit",
                            "suspend_medical",
                            "school_close_state")
    
  } else {
    
    state_interventions = colnames(data.google)[intv.colums]
    
  }
  
  # set up
  predictors = list(county_census = c("log10_popsize",
                                      "med_income",
                                      "percent_poverty",
                                      'med_age',
                                      'prop_white',
                                      'prop_belowCollege',
                                      "log10_popdense"),
                    
                    state_interventions = state_interventions,
                    
                    state = "state_name",
                  
                    county_time = c(colnames(a)[3:ncol(a)]),
                    
                    country_time = c(colnames(country_weeks)[2:ncol(country_weeks)]),
                  
                    autoregressive = "log_Rt_previous")
  
  model.types = list(main = 'GEE', 
                     base = 'GEE', 
                     timeOnly = 'GEE',
                     timeIntv = 'GEE', 
                     
                     lmMain = 'Linear',
                     lmBase = 'Linear',
                     lmTimeOnly = 'Linear',
                     lmTimeIntv = 'Linear', 
                     
                     lassoMain = 'LASSO',
                     lassoTime = 'LASSO',
                     lassoIntv = 'LASSO',
                     
                     countryTimeIntv = 'GEE',
                     lmCountryTimeIntv = 'Linear')
  
  model.predictors = list(main = c('autoregressive',
                                   'county_census',
                                   'state_interventions',
                                   'state'),
                        
                          base = c('county_census',
                                   'state'),
                        
                          timeOnly = c('county_time',
                                       'county_census',
                                       'state'),
                        
                          timeIntv = c('state_interventions',
                                       'county_time',
                                       'county_census',
                                       'state'),
                        
                          lmMain = c('autoregressive',
                                     'county_census',
                                     'state_interventions',
                                     'state'),
                                                    
                          lmBase = c('autoregressive',
                                     'county_census',
                                     'state'),
                        
                          lmTimeOnly = c('autoregressive',
                                         'county_time',
                                         'county_census',
                                         'state'),
                        
                          lmTimeIntv = c('autoregressive',
                                         'state_interventions',
                                         'county_time',
                                         'county_census',
                                         'state'),
                          
                          lassoMain = c('autoregressive',
                                        'county_census',
                                        'state_interventions',
                                        'state'),
                        
                          lassoTime = c('autoregressive',
                                        'county_census',
                                        'state'),
                        
                          lassoIntv = c('county_census',
                                        'state_interventions',
                                        'state'),
                          
                          countryTimeIntv = c('state_interventions',
                                              'country_time',
                                              'county_census',
                                              'state'),
                          
                          lmCountryTimeIntv = c('autoregressive',
                                                'state_interventions',
                                                'country_time',
                                                'county_census',
                                                'state'))
  
  xs = unlist(sapply(model.predictors[[model]], function(x) predictors[[x]]))
  
  fml.log <-  paste('log_Rt ~ ',
                    paste(xs, collapse = " + "),
                    sep = "")
  
  fml.used <- as.formula(fml.log)

  if(model.types[[model]] == 'Linear'){

    m = lm(fml.used,
           weights = weights,
           data = dat)

  }

  if(model.types[[model]] == 'GEE'){

    m = geeglm(fml.used,
                data = dat,
                id = FIPS,
                corstr = "exchangeable",
                weights = weights)



  }

  if(model.types[model][[1]] == 'LASSO'){

    lambda = seq(0, 0.1, 0.005)

    x = model.matrix(log_Rt ~ .-1,
                     dat[ ,c(xs,
                                   'log_Rt')])
    y = dat$log_Rt
    w = dat$weights

    m = glmnet(x,
               y,
               alpha = 1,
               lambda = lambda,
               weights = w)

  }

  return(m)

}

modelsSP = lapply(c("main"),
                modelFitSP,
                dat = dat,
                stateLevel = FALSE)

getEstCompSp <-function(model.used) {# 1 = duration; 2 = categorical

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         'prop_white',
         'prop_belowCollege',
         'log10_popdense',
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")

  esti = summary(model.used[[1]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = 'Spatial')


  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


}

est.comp.sp = getEstCompSp(modelsSP)

est.comp.sp = rbind(est.comp.sp,
                    est[est$Model == 'GEE',
                        1:5])
est.comp.sp$Model[est.comp.sp$Model == 'GEE'] = 'Main'

pSPCorr <- ggplot(data = est.comp.sp,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = '')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'right',
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14)) +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#083765"),
                     labels = c('Main', 'Spatial')) +
  scale_y_discrete(labels = labels.order) +
    scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                       labels = c('-60', '-40', '-20', '0', '20', '40'),
                       limits = c(0.4, 1.4), 
                       expand = c(0, 0))

jpeg("output/plot/fig_s20.jpeg",
     width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s20.pdf",
     width = 10, height = 7.5)
pSPCorr
dev.off()

```

# Figure S21 - culter-robust analysis

```{r fig s21, include=FALSE,  warning=FALSE, message=FALSE}

getMeltCRSD = function(dat){
  
  fml.used = as.formula(log_Rt ~ log_Rt_previous + log10_popsize + med_income + percent_poverty + med_age + prop_white + prop_belowCollege + log10_popdense + daycare_close + face_mask + lifestyle_close + lv3_stay_home + ban_nursing_home_visit + suspend_medical + earliest_date_school_closed + state_name)
  
  m = feols(fml.used,
            weights = dat$weights,
            data = dat)
  
  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  # standard errors: standard, two way (county * time)
  smr = list(summary(m),
             summary(m,
                     cluster = ~ FIPS + Date))
  
  model.type = c('main OLS',
                 'County-week cluster')
  
  tem = lapply(1:2, function(x){
    
    s = smr[[x]]
    
    esti = s$coefficients[nm]
    ci = cbind(esti - 1.96*s$se[nm],
               esti + 1.96*s$se[nm])
    rownames(ci) = rownames(esti)
    
    tem = data.frame(intervention = nm,
                     coefficients = esti,
                     ci.lower = ci[,1],
                     ci.upper = ci[,2],
                     Model = model.type[x],
                     variables = c(rep("Census", 7),
                                   rep("Intervention",
                                       length(nm)-7)))
    
    tem
    
  })
  
  tem = do.call('rbind', tem)
  
  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)
  
  tem$intervention = factor(tem$intervention,
                            levels = nm)
  
  tem
  
}

estRobustCluster = getMeltCRSD(dat)

figRC <- ggplot(data = estRobustCluster,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
                position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = '')+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16,
                                   color = 'black'),
        legend.title = element_text(size = 16,
                                    color = 'black'),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  scale_color_manual(name = "Model",
                     values = c( "#5488a5", "#3baee5")) +
  scale_y_discrete(labels = labels.order) +
  scale_x_continuous(breaks = seq(0.5, 1.3, 0.1),
                     labels = c('-50', '-40', '-30', 
                                '-20', '-10', '0', '10', '20', '30'),
                     limits = c(0.5, 1.3),
                     expand = c(0, 0))

jpeg("output/plot/fig_s21.jpeg",
     width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s21.pdf",
     width = 10, height = 7.5)
figRC
dev.off()


```

# Figure S22 - Estimate Reff from stochastic reconstruction of cases

```{r fig s22 data, echo=FALSE, fig.width=10, fig.height=6.5, include=FALSE}

data.case = read.csv('data/covariates_reconstruction_cases.csv',
                       header = TRUE,
                       stringsAsFactors = FALSE)
rt.case = read.csv('rt/rt_reconstruction_cases.csv',
                       header = TRUE,
                       stringsAsFactors = FALSE)

data.case = left_join(rt.case, data.case)
data.case$Date = as.Date(data.case$Date)

models.case = list(modelFit(model = 'main',
                             dat = data.case,
                             stateLevel = FALSE),
                    
                    modelFit(model = 'lmMain',
                        dat = data.case,
                        stateLevel = FALSE))
names(models.case) = c('main', 'lmMain')


```

```{r  fig s22, echo=FALSE, fig.width=8, fig.height=5}

est.case <- lapply(c('main', 'lmMain'),
              function(model){# 1 = gee; 2 = log-lm

  nm = c("log10_popsize",
         "med_income",
         "percent_poverty",
         "med_age",
         "prop_white",
         "prop_belowCollege",
         "log10_popdense",
         "face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  if(model == 'main'){type = 'GEE'} else {type = 'OLS'}

  esti = summary(models.case[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   variables = c(rep("Census", 3),
                                 rep("Intervention",
                                     length(nm)-3)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.case <- do.call('rbind', est.case)

pDeconv <- ggplot(data = est.case,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = '')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'right') +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = labels.order) +
  scale_x_continuous(breaks = seq(0.4, 1.4, 0.2),
                    labels = c('-60', '-40', '-20', '0', '20', '40'),
                    limits = c(0.4, 1.4), 
                    expand = c(0, 0))

# jpeg("output/plot/fig_s22.jpeg",
#      width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s22.pdf",
     width = 10, height = 7.5)
pDeconv
dev.off()

```

# Figure S23 - Estimate Reff from deconvolution of death data

## Using deconvolution death Rt
```{r  fig s23 data, echo=FALSE, fig.width=10, fig.height=6.5, include=FALSE}

data.death.deconv = read.csv('data/covariates_deconvolution_deaths.csv',
                       header = TRUE,
                       stringsAsFactors = FALSE)
rt.death.deconv = read.csv('rt/rt_deconvolution_deaths.csv',
                       header = TRUE,
                       stringsAsFactors = FALSE)

data.death.deconv = left_join(rt.death.deconv, data.death.deconv)
data.death.deconv$Date = as.Date(data.death.deconv$Date)

models.death.deconv = list(modelFit(model = 'main',
                                    dat = data.death.deconv,
                                    stateLevel = FALSE),
                    
                           modelFit(model = 'lmMain',
                                    dat = data.death.deconv,
                                    stateLevel = FALSE))
names(models.death.deconv) = c('main', 'lmMain')


```

```{r  fig s23, echo=FALSE, fig.width=8, fig.height=5}

est.death.deconv <- lapply(c('main', 'lmMain'),
                           function(model){# 1 = gee; 2 = log-lm
                             
                             
    nm = c("log10_popsize",
           "med_income",
           "percent_poverty",
           "med_age",
           "prop_white",
           "prop_belowCollege",
           "log10_popdense",
           "face_mask",
           "suspend_medical",
           "ban_nursing_home_visit",
           "earliest_date_school_closed",
           "daycare_close", 
           "lv3_stay_home",
           "lifestyle_close")
  
  if(model == 'main'){type = 'GEE'} else {type = 'OLS'}

  esti = summary(models.death.deconv[[model]])$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)

  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = type,
                   variables = c(rep("Census", 3),
                                 rep("Intervention",
                                     length(nm)-3)))

  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)

  tem$intervention = factor(tem$intervention,
                            levels = nm)

  tem


})

est.death.deconv <- do.call('rbind', est.death.deconv)

pDeconvDeath <- ggplot(data = est.death.deconv,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model,
                    shape = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
    position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = "",
       title = '')+
    theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 14,
                                   color = 'black'),
        axis.text.y = element_text(size = 14,
                                   color = 'black'),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 14, face = 'bold'),
        axis.title.y = element_text(size = 14, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        plot.margin = unit(c(2,1,1,1), "cm"),
        legend.position = 'right') +
  scale_color_manual(name = "Model",
                     values = c( "#d9534f", "#3baee5")) +
  scale_y_discrete(labels = labels.order) +
  scale_x_continuous(breaks = seq(0.2, 2, 0.2),
                     labels = c('-80', '-60', '-40', '-20', '0', '20', '40', '60', '80', 100),
                     limits = c(0.2, 2),
                     expand = c(0, 0))

jpeg("output/plot/fig_s23.jpeg",
     width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s23.pdf",
     width = 10, height = 7.5)
pDeconvDeath
dev.off()

```


# Figure 24 - Fixed effect of county
```{r fig s24}

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset

country_weeks = dummy(dat$time_since_national_start, sep = '_')
colnames(country_weeks) = paste('country_week', 6:21, sep = '_')

a = dummy(data.google$week, sep = '_')
colnames(a) = paste('week', -2:13, sep = "_")
colnames(a) = gsub('-', 'neg', colnames(a))

modelFitCountyFixed = function(dat){
  
  
  fml.used <- as.formula(log_Rt ~ log_Rt_previous + daycare_close + face_mask + lifestyle_close + lv3_stay_home + ban_nursing_home_visit + suspend_medical + earliest_date_school_closed + factor(FIPS))
  
  
  m = lm(fml.used,
         weights = weights,
         data = dat)
  
  esti = summary(m)$coefficients
  ci = cbind(esti[,1] - 1.96*esti[ ,2],
             esti[,1] + 1.96*esti[ ,2])
  rownames(ci) = rownames(esti)
  
  nm = c("face_mask",
         "suspend_medical",
         "ban_nursing_home_visit",
         "earliest_date_school_closed",
         "daycare_close",
         "lv3_stay_home",
         "lifestyle_close")
  
  tem = data.frame(intervention = nm,
                   coefficients = esti[nm, 1],
                   ci.lower = ci[nm, 1],
                   ci.upper = ci[nm, 2],
                   Model = 'Fixed county effect',
                   variables = c(rep("Census", 7),
                                 rep("Intervention",
                                     length(nm)-7)))
  
  tem$coefficients = 10^(tem$coefficients)
  tem$ci.lower = 10^(tem$ci.lower)
  tem$ci.upper = 10^(tem$ci.upper)
  
  tem$intervention = factor(tem$intervention,
                            levels = nm)
  
  tem
  
}

estFixedCounty = modelFitCountyFixed(dat)

estFixedCounty = rbind(est[est$Model == 'OLS' &
                             est$variables == 'Intervention', 
                           1:6],
                       estFixedCounty)

figFixed <- ggplot(data = estFixedCounty,
                aes(y = factor(intervention,
                               levels = intv.order),
                    x = coefficients,
                    color = Model)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin=ci.lower,
                    xmax=ci.upper,
                    color = Model), width=.5,
                position=position_dodge(0.5)) +
  geom_vline(xintercept = 1,
             linetype = 3) +
  labs(x = expression(paste("Relative changes in R"[eff], " ,%")),
       y = '',
       title = '')+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 0, 
                                   hjust = 0.5, 
                                   size = 16,
                                   color = 'black'),
        axis.text.y = element_text(size = 16,
                                   color = 'black'),
        strip.text.x = element_text(size = 16, face = "bold"),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 16, face = 'bold'),
        axis.title.y = element_text(size = 16, face = 'bold'),
        plot.title = element_text(size = 20, face = 'bold'),
        plot.title.position = "plot",
        legend.position = 'top',
        legend.text = element_text(size = 16,
                                   color = 'black'),
        legend.title = element_text(size = 16,
                                    color = 'black')) +
  scale_color_manual(name = "Model",
                     values = c( "#0b222d", "#3baee5"),
                     labels = c('Fixed county effect',
                                'Main OLS')) +
  scale_y_discrete(labels = labels.order) +
  scale_x_continuous(breaks = seq(0.6, 1.1, 0.1),
                     labels = c('-40', '-30', 
                                '-20', '-10', '0', '10'),
                     limits = c(0.6, 1.1),
                     expand = c(0, 0))


jpeg("output/plot/fig_s24.jpeg",
     width = 10*600, height = 7.5*600, res = 600)
pdf("output/plot/fig_s24.pdf",
     width = 10, height = 7.5)
figFixed
dev.off()

```

# Table S3 - R2 and AIC

## R2 and QIC for gee
```{r r sq , echo=FALSE}

## R2 from https://www.researchgate.net/post/R_code_for_calculating_r-squared_values_from_GEE

tabForRsq = function(models){

  tab = matrix(nrow = 6,
               ncol = 5)
  colnames(tab) = c('Variable',
                    'Base',
                    'Main model',
                    'County time model',
                    'County time and interventions model')

  tab[ ,1] = c('Model type',
               'Census',
               'Additional time',
               'Intervention',
               'Adj. R.sq',
               'AIC')

  tab[1 , 2:5] = 'GEE'
  tab[2, 2:5] = 'Yes'
  tab[3 , 2:5] = c('-',
                   '-',
                   "Weeks since countys first case",
                   "Weeks since countys first case")
  tab[4, 2:5] = c('No', 'Yes', 'No', 'Yes')

  # R2
  tab[5, 2:5] = sapply(c(2,1,3,4), function(x){
    
    y_bar = mean(models[[x]]$y, na.rm = T)
                 
    r2 = 1 - (sum(models[[x]]$weights * (models[[x]]$y - models[[x]]$fitted.values)^2, na.rm = T)/sum(models[[x]]$weights*(models[[x]]$y - y_bar)^2, na.rm = T))

    r2 = round(r2*100, 1)

    paste(r2, '%', sep = '')

  })

  qic = sapply(c(2,1,3,4), function(x){

    qic = QIC(models[[x]])[1]

    round(qic, 1)

  })
  
  tab[6, 2:5] = c('ref', qic[2:4]-qic[1])
  
  tab


}

write.csv(tabForRsq(models),
          'output/table_s2_gee.csv',
          row.names = FALSE)


```

## R2 and AIC for log-linear regression
```{r r sq , echo=FALSE}

tabForRsq = function(models){

  tab = matrix(nrow = 6,
               ncol = 5)
  colnames(tab) = c('Variable',
                    'Base',
                    'Main model',
                    'County time model',
                    'County time and interventions model')

  tab[ ,1] = c('Model type',
               'Census',
               'Additional time',
               'Intervention',
               'Adj. R.sq',
               'AIC')

  tab[1 , 2:5] = 'Log-linear'
  tab[2, 2:5] = 'Yes'
  tab[3 , 2:5] = c('-',
                   '-',
                   "Weeks since countys first case",
                   "Weeks since countys first case")
  tab[4, 2:5] = c('No', 'Yes', 'No', 'Yes')

  tab[5, 2:5] = sapply(c(6, 5, 7:8), function(x){

    r2 = summary(models[[x]])$adj.r.squared

    r2 = round(r2*100, 1)

    paste(r2, '%', sep = '')

  })

  aic = sapply(c(6, 5, 7:8), function(x){

    aic = AIC(models[[x]])

    round(aic, 1)

  })
  
  tab[6, 2:5] = c('ref', aic[2:4]-aic[1])
  
  tab


}

write.csv(tabForRsq(models),
          'output/table_s2_ll.csv',
          row.names = FALSE)



```


# Table S4 - Training testing RMSE/MASE/R sq.

```{r Training testing, echo = FALSE, warning = FALSE, fig.width=14, fig.height=12, fig.align='cneter'}

source('../RCodes/genericFunctions.R')

dat = data.google
dat = dat[ ,!(colnames(dat) %in% c("date_all_school_closed",
                                   "date_partial_school_closed"))]
dat = dat[rowSums(is.na(dat)) == 0, ] # to make sure all analyses used the same dataset

testing = function(data.main, state.used){
  
  train = data.main[data.main$state_name != state.used, ]
  test = data.main[data.main$state_name == state.used, ]
  
  # fml = as.formula('log_Rt ~ log_Rt_previous + log10_popsize + med_income + percent_poverty + state_of_emergency + daycare_close + face_mask + lifestyle_close + lv3_stay_home + ban_nursing_home_visit + suspend_medical + earliest_date_school_closed')
  
    fml = as.formula('log_Rt ~ log_Rt_previous + log10_popsize + med_income + percent_poverty + daycare_close + face_mask + lifestyle_close + lv3_stay_home + ban_nursing_home_visit + suspend_medical + earliest_date_school_closed')
     
  m = lm(fml,data = data.main, weights = weights)
   
  pred = predict(m, newdata = test)
  
  df = data.frame(state = state.used,
                  FIPS = test$FIPS,
                  date = test$Date,
                  observed = test$log_Rt,
                  predict = pred,
                  stringsAsFactors = FALSE)
  
  return(df)
  
}

pred = lapply(state, testing, data.main = dat)

measures = lapply(pred, function(p) {
  
  p = p[order(p$FIPS, p$date), ]
  
  yt = p$observed
  
  ft = p$predict
  
  MASE = sapply(unique(p$FIPS), function(f){
    
    used = p[p$FIPS == f, ]
    
    qt = ase(n = nrow(used),
             yt = used$observed,
             ft = used$predict)
    
    mase(qt, method = mean)
    
  })
  
  data.frame(state = p$state[1],
             r2 = rsq(yt, ft),
             mase = mean(MASE),
             rmse = rmse(yt, ft),
             stringsAsFactors = FALSE)
  
})
measures = do.call('rbind', measures)

pred = do.call('rbind', pred)

p1 = ggplot(data = pred,
            aes(x = observed,
                y = predict)) +
  geom_point(size = 3,
             # color = "#BEBEBE40", 
             color = '#8fa8ec',
             alpha = 0.3) +
  geom_abline(intercept = 0,
              slope = 1,
              linetype = 'dashed') +
  geom_smooth(method = lm,
              color = '#0059b3') +
  facet_wrap(~ state) +
  xlim(-1.5, 1.5) +
  ylim(-1.5, 1.5) +
  theme_classic() +
  theme(
    legend.position = "bottom",
    strip.background = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)
  )

p1

summary(measures[,2:4])

```

# Table S6 - Census data
```{r reg census, echo=FALSE, fig.width=12, fig.height=6, warning=FALSE, message=FALSE, include=TRUE}

dat = data.google

census = c('med_income',
           'percent_poverty',
           'log10_popdense',
           'log10_popsize',
           'med_age',
           'prop_white',
           'prop_belowCollege')

r2 = lapply(census, function(x){

  fml.log <-  paste('log_Rt ~ ', x, sep = "")

  fml.used <- as.formula(fml.log)

  m = lm(fml.used, data = dat, weights = weights)

  # r.sq = paste('Adj. R squared ',
  #              round(summary(m)$adj.r.squared*100, 2),
  #              '%',
  #              sep = '')
    r.sq = paste(round(summary(m)$adj.r.squared*100, 2),
               '%',
               sep = '')

  c(x,
    round((10^coef(m)[2]-1)*100, 1),
    paste('(',
          round((10^confint(m)[2,1]-1)*100, 1),
          ', ',
          round((10^confint(m)[2,2]-1)*100, 1) ,
          ')',
          sep = ''),
    r.sq)

})

r2 = do.call('rbind', r2)
colnames(r2) = c("", 'Estimate', '95% CI', "Adj. R squared")

write.csv(r2,
          'output/table_s6.csv',
          row.names = FALSE)

```

# The following analyses were added per reviewers' request ----------------%

# Compare county- and state-level school closure
Sections below are sensivity analyses using state-level school closure to replicate Figure 3

```{r compare school closures, echo=FALSE, warning=FALSE, message=FALSE}

comp = table(data.google$school_close, 
             data.google$earliest_date_school_closed)
colnames(comp) = c('County No', 'County Yes')
rownames(comp) = c('State No', 'State Yes')

kable(round(prop.table(comp), 3)*100)

```

